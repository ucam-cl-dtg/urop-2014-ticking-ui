<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../sheet-selector.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../are-you-sure.html">

<polymer-element name="signup-component" attributes="tickId sheets signedUp unitPass testRunning humanPass">
    <template>
        <link rel="stylesheet" type="text/css" href="../../css/shared-styles.css" shim-shadowdom>
        <link rel="stylesheet" type="text/css" href="tick-components.css" shim-shadowdom>

        <!-- Call to delete a sign up -->
        <toast-ajax
                id="ajaxDeleteBooking"
                url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/bookings/' + tickId + '/'}}"
                handleAs="json"
                method="DELETE"
                on-core-response="{{deleteSuccess}}"

                waitMessage="Cancelling booking..."
                waitBeforeToast="500"
                captureError
                popUpError
                errorMessage="Error cancelling booking."
                popUpComplete
                completeMessage="Booking cancelled.">
        </toast-ajax>

        <!-- Sign up button -->
        <core-collapse opened?="{{!signedUp && !testRunning && unitPass && !humanPass}}">
            <paper-button class="tick-component" label="BOOK TICKING SESSION" on-tap="{{openSignupDialog}}"></paper-button>
        </core-collapse>

        <!-- Cancel sign up button -->
        <core-collapse opened?="{{signedUp && !humanPass}}">
            <paper-button class="tick-component" label="CANCEL TICKING SESSION" on-tap="{{showCancelDialog}}"></paper-button>
        </core-collapse>

        <!-- Error message: sign up unavailable because the unit tester has not been passed -->
        <core-collapse opened?="{{!testRunning && !unitPass && !humanPass}}">
            <div class="error">Booking unavailable (automated tests not passed)</div>
        </core-collapse>

        <!-- Error message: sign up unavailable because a test is running -->
        <core-collapse opened?="{{testRunning && !humanPass}}">
            <div class="error">Booking unavailable (test running)</div>
        </core-collapse>

        <!-- Error message: tick has been passed -->
        <core-collapse opened?="{{humanPass}}">
            <div class="error">PASSED</div>
        </core-collapse>

        <!-- Sign ups dialog -->
        <sheet-selector id="signupDialog" sheets="{{sheets}}" tickId="{{tickId}}"></sheet-selector>

        <are-you-sure
                id="cancelDialog"
                heading="Cancel Ticking Session?"
                on-yes="{{deleteBooking}}">
        </are-you-sure>
    </template>
    <script>
        Polymer('signup-component', {
            domReady: function() {
                var that = this;
                this.$.signupDialog.addEventListener('slot-booked', function(e){
                    console.log(e);
                    that.signedUp = true;
                });
            },

            openSignupDialog: function() {
                this.$.signupDialog.toggle();
            },

            showCancelDialog: function() {
                this.$.cancelDialog.toggle();
            },

            deleteBooking: function() {
                this.$.ajaxDeleteBooking.go();
            },

            deleteSuccess: function() {
                this.signedUp = false;
            }
        });
    </script>
</polymer-element>