<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../sheet-selector.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<polymer-element name="signup-component" attributes="tickId sheets signedUp unitPass testRunning">
    <template>
        <link rel="stylesheet" href="../../css/shared-styles.css">
        <link rel="stylesheet" href="tick-components.css">

        <style>
            .dialogYes {
                background-color: #259b24; /* Material Green 500 */
                color: #FFFFFF;
                margin-left: 5px;
            }
            .dialogNo {
                background-color: #e51c23; /* Material Red 500 */
                color: #FFFFFF;
                margin-right: 5px;
            }
        </style>

        <!-- Call to delete a sign up -->
        <core-ajax id="ajaxDeleteBooking"
                   url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/bookings/' + tickId + '/'}}"
                   handleAs="json"
                   method="DELETE"
                   on-core-response="{{deleteSuccess}}"
                   on-core-error="{{deleteError}}">
        </core-ajax>



        <!-- Sign up button -->
        <core-collapse opened?="{{!signedUp && !testRunning && unitPass && !humanPass}}">
            <paper-button class="greenButton" label="SIGN UP" on-tap="{{openSignupDialog}}"></paper-button>
        </core-collapse>

        <!-- Cancel sign up button -->
        <core-collapse opened?="{{signedUp && !humanPass}}">
            <paper-button class="greenButton" label="CANCEL SIGN UP" on-tap="{{showCancelDialog}}"></paper-button>
        </core-collapse>

        <!-- Error message: sign up unavailable because the unit tester has not been passed -->
        <core-collapse opened?="{{!testRunning && !unitPass && !humanPass}}">
            <div class="error">Sign up unavailable (automated tests not passed)</div>
        </core-collapse>

        <!-- Error message: sign up unavailable because a test is running -->
        <core-collapse opened?="{{testRunning && !humanPass}}">
            <div class="error">Sign up unavailable (test running)</div>
        </core-collapse>

        <!-- Error message: tick has been passed -->
        <core-collapse opened?="{{humanPass}}">
            <div class="error">PASSED</div>
        </core-collapse>

        <!-- Sign ups dialog -->
        <sheet-selector id="signupDialog" sheets="{{sheets}}" tickId="{{tickId}}"></sheet-selector>

        <paper-dialog id="cancelDialog" heading="Cancel Sign up?" backdrop transition="core-transition-top">
            <paper-button class="dialogNo" dismissive label="No"></paper-button>
            <paper-button class="dialogYes" affirmative label="Yes" on-tap="{{deleteBooking}}"></paper-button>
        </paper-dialog>

        <paper-toast id="toastDeleteSuccess" text="Booking cancelled."></paper-toast>
        <paper-toast id="toastDeleteError" text="Error cancelling booking."></paper-toast>
    </template>
    <script>
        Polymer('signup-component', {
            domReady: function() {
                var that = this;
                this.$.signupDialog.addEventListener('slot-booked', function(e){
                    console.log(e);
                    that.signedUp = true;
                });
            },

            openSignupDialog: function() {
                this.$.signupDialog.toggle();
            },

            showCancelDialog: function() {
                this.$.cancelDialog.toggle();
            },

            deleteBooking: function() {
                this.$.ajaxDeleteBooking.go();
            },

            deleteSuccess: function() {
                this.signedUp = false;
                this.$.toastDeleteSuccess.toggle();
            },

            deleteError: function() {
                this.$.toastDeleteError.toggle();
            }
        });
    </script>
</polymer-element>