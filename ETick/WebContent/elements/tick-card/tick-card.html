<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="submit-component.html">
<link rel="import" href="report-component.html">
<link rel="import" href="signup-component.html">
<link rel="import" href="fork-service.html">
<link rel="import" href="fork-component.html">
<link rel="import" href="../date-calendar.html">

<polymer-element name="tick-card" attributes="tickName tickId sheets
                                              repoName tickObj
                                              lastTickedBy lastTickedOn">
    <template>
        <link rel="stylesheet" href="../../css/elements/group-members.css">
        <link rel="stylesheet" href="tick-components.css">

        <!--<style>-->
            <!--h1 {-->
                <!--margin: 0;-->
            <!--}-->
            <!--:host {-->
                <!--margin-top: 10px;-->
            <!--}-->
        <!--</style>-->

        <style>
            :host {
                margin: 10px;
            }
            h1 {
                margin: 0;
                padding: 0;
                font-size: 1.8rem;
                font-weight: lighter;
            }
            h2 {
                font-weight: normal;
                font-size: 1.2rem;
            }
            paper-input {
                width: 100%;
            }
            core-icon.big {
                height: 27px;
                width: 27px;
                margin-right: 10px;
                margin-top: 8px;
            }
            paper-input.datetime {
                width: initial;
                margin-right: 20px;
            }
            #submitButton {
                background: #259b24;
                color: #fff;
            }

            #buttonsContainer paper-button {
                width: 18%;
                margin: 20px 10px 10px;
            }
        </style>

        <!-- for managing fork object data -->
        <fork-service
                id="forkService"
                tickId="{{tickId}}"
                unitPass="{{unitPass}}"
                humanPass="{{humanPass}}"
                signedUp="{{signedUp}}"
                testRunning="{{testRunning}}"
                reportAvailable="{{reportAvailable}}"
                repo="{{repo}}"
                forked="{{forked}}"
                lastTickedBy="{{lastTickedBy}}"
                lastTickedOn="{{lastTickedOn}}">
        </fork-service>

        <div id="mainContainer" layout horizontal>

            <div flex>
                <div layout horizontal style="margin-right: 10px;">
                    <h1 flex vertical center>{{tickName}}</h1>
                    <span layout vertical>
                        <div flex></div>
                        <div class="error">{{datetime == null ? 'No deadline' : 'Deadline:&nbsp;'}}</div>
                        <div flex></div>
                    </span>

                    <core-collapse style="margin-right: -10px;" opened?="{{datetime != null}}" horizontal>
                        <div style="padding: 3px;">
                            <date-calendar datetime="{{datetime}}" hexColorPrimary="{{deadlinePassed ? '#e51c23' : '#259b24'}}"></date-calendar>
                        </div>
                    </core-collapse>
                </div>

                <core-collapse opened?="{{displayRepo != null}}">
                    <h2>Repository</h2>
                    <div layout horizontal start>
                        <!--<div style="width: 24px;"></div> &lt;!&ndash; 24px is the core-icon width &ndash;&gt;-->
                        <div>{{displayRepo}}</div>
                    </div>
                </core-collapse>

                <br>

                <core-collapse opened?="{{!forked}}">
                    <fork-component
                            on-create-fork="{{createFork}}"
                            repo="{{repo}}">
                    </fork-component>
                </core-collapse>

                <core-collapse opened?="{{forked}}">
                    <h2>Submissions</h2>
                    <submit-component flex
                                      id="submitComponent"
                                      tickId="{{tickId}}"
                                      signedUp="{{signedUp}}"
                                      testRunning="{{testRunning}}"
                                      reportAvailable="{{reportAvailable}}"
                                      unitPass="{{unitPass}}"
                                      humanPass="{{humanPass}}"
                                      repo="{{repo}}"
                                      deadline="{{tickObj.deadline}}">
                    </submit-component>

                    <h2>Ticking Session</h2>
                    <signup-component flex
                                      sheets="{{sheets}}"
                                      signedUp="{{signedUp}}"
                                      unitPass="{{unitPass}}"
                                      testRunning="{{testRunning}}"
                                      tickId="{{tickId}}"
                                      humanPass="{{humanPass}}">
                    </signup-component>
                    </div>
                </core-collapse>

                <div style="width: 20px;"></div>
            </div>
        </div>
        <br><br>
    </template>
    <script>
        Polymer('tick-card', {
            created: function() {
                this.unitPass = null;
                this.humanPass = null;
                this.signedUp = null;
                this.testRunning = null;
                this.reportAvailable  = null;
                this.repo = null;
                this.displayRepo = null;
                this.repoName = null;
                this.tickObj = null;
                this.datetime = null;
                this.deadlinePassed = null;
            },

            domReady: function() {
                var that = this.$;
                this.$.forkService.addEventListener('test-running', function() {
                    that.submitComponent.continuePolling();
                });
            },

            tickObjChanged: function() {
                console.log("tickObj changed", this.tickObj);

                if (this.tickObj.deadline == null) {
                    this.datetime = null;
                    this.deadlinePassed = false;
                } else {
                    this.datetime = new Date(this.tickObj.deadline);
                    this.deadlinePassed = this.datetime < new Date();
                    console.log("deadline Passed?", this.deadlinePassed);
                }
            },

            createFork: function() {
               this.$.forkService.createFork();
            },

            repoChanged: function() {
                console.log("repo is now " + this.repo);

                if (this.repo != null) {
                    this.displayRepo = this.repo;
                }

                console.log("so display repo is now " + this.displayRepo);

                this.reportAvailableChanged();
            },

            reportAvailableChanged: function() {
                if (this.reportAvailable && this.repo != null) {
                    this.showReport();
                } else {
                    this.repoName = null;
                }
            },

            showReport: function() {
                this.job('show-report', function(){
                    var regex = /urop2014\.dtg\.cl\.cam\.ac\.uk\/(.*)\.git/;
                    this.repoName = this.repo.match(regex)[1];
                }, 500);
            }

            /* testRunningChanged: function() {
                console.log(this.testRunning);

                if (this.testRunning == true) {
                    this.$.submitComponent.continuePolling();
                }
            }*/
        });
    </script>
</polymer-element>
