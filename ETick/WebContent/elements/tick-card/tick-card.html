<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="submit-component.html">
<link rel="import" href="report-component.html">
<link rel="import" href="signup-component.html">
<link rel="import" href="fork-service.html">
<link rel="import" href="fork-component.html">

<polymer-element name="tick-card" attributes="tickName tickId sheets repoName tickObj">
    <template>
        <link rel="stylesheet" href="../../css/elements/group-members.css">
        <link rel="stylesheet" href="tick-components.css">

        <!-- for managing fork object data -->
        <fork-service
                id="forkService"
                tickId="{{tickId}}"
                unitPass="{{unitPass}}"
                humanPass="{{humanPass}}"
                signedUp="{{signedUp}}"
                testRunning="{{testRunning}}"
                reportAvailable="{{reportAvailable}}"
                repo="{{repo}}"
                forked="{{forked}}">
        </fork-service>

        <div id="mainContainer">

            <h1>{{tickName}}</h1>

            <core-collapse opened?="{{repo != null}}">
            <div layout horizontal>
                <div class="spacer"></div>
                <div>{{repo}}</div>
            </div>
            </core-collapse>


            <br>

            <core-collapse opened?="{{!forked}}">
                <fork-component
                        on-create-fork="{{createFork}}">
                </fork-component>
            </core-collapse>

            <core-collapse opened?="{{forked}}">
                <div layout horizontal>
                    <div class="spacer"></div>
                    <submit-component flex
                                      id="submitComponent"
                                      tickId="{{tickId}}"
                                      signedUp="{{signedUp}}"
                                      testRunning="{{testRunning}}"
                                      reportAvailable="{{reportAvailable}}"
                                      unitPass="{{unitPass}}"
                                      humanPass="{{humanPass}}"
                                      deadline="{{tickObj.deadline}}">
                    </submit-component>
                    <div class="spacer"></div>
                    <!--<report-component flex
                                      reportAvailable="{{reportAvailable}}"
                                      repoName="{{repoName}}"
                                      repo="{{repo}}"
                                      testRunning="{{testRunning}}"
                                      unitPass="{{unitPass}}"></report-component>
                    <div class="spacer"></div>-->
                    <signup-component flex
                                      sheets="{{sheets}}"
                                      signedUp="{{signedUp}}"
                                      unitPass="{{unitPass}}"
                                      testRunning="{{testRunning}}"
                                      tickId="{{tickId}}"
                                      humanPass="{{humanPass}}">
                    </signup-component>
                    <div class="spacer"></div>
                </div>
            </core-collapse>
        </div>
        <br><br>
    </template>
    <script>
        Polymer('tick-card', {
            created: function() {
                this.unitPass = null;
                this.humanPass = null;
                this.signedUp = null;
                this.testRunning = null;
                this.reportAvailable  = null;
                this.repo = null;
                this.deadline = null;

                this.repoName = null;
                this.tickObj = null;
            },

            tickObjChanged: function() {
                console.log("Tick object:");
                console.log(this.tickObj.deadline);

            },

            domReady: function() {
                var that = this.$;
                this.$.forkService.addEventListener('test-running', function() {
                    that.submitComponent.continuePolling();
                });
            },

            createFork: function() {
               this.$.forkService.createFork();
            },

            repoChanged: function() {
                this.reportAvailableChanged();
            },

            reportAvailableChanged: function() {
                if (this.reportAvailable) {
                    this.showReport();
                } else {
                    this.repoName = null;
                }
            },

            showReport: function() {
                this.job('show-report', function(){
                    var regex = /urop2014\.dtg\.cl\.cam\.ac\.uk\/(.*)\.git/;
                    this.repoName = this.repo.match(regex)[1];
                }, 500);
            }

            /* testRunningChanged: function() {
                console.log(this.testRunning);

                if (this.testRunning == true) {
                    this.$.submitComponent.continuePolling();
                }
            }*/
        });
    </script>
</polymer-element>