<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-icons/communication-icons.html">
<link rel="import" href="../bower_components/core-icons/device-icons.html">
<link rel="import" href="../bower_components/core-icons/image-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="date-entry.html">


<polymer-element name="add-edit-session" attributes="sheet gid">
	<template>
		<style>
			:host {
				display: block;
				margin: 10px;
			}
			h1 {
				font-size: 1.8rem;
				font-weight: lighter;
			}
			h2 {
				font-weight: normal;
				font-size: 1.2rem;
			}
			paper-input {
				width: 100%;
			}
			core-icon.big {
				height: 27px;
       			width: 27px;
       			margin-right: 10px;
				margin-top: 8px;
			}
			paper-input.datetime {
				width: initial;
				margin-right: 20px;
			}
			#submitButton {
				background: #259b24;
				color: #fff;
			}

			#buttonsContainer paper-button {
				width: 18%;
				margin: 20px 10px 10px;
			}
		</style>

		<!-- Add session API call. -->
		<core-ajax id="addSessionAPI"
			url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets"
			method="POST"
			contentType="application/json"
			on-core-response="{{addSessionResponse}}"
			on-core-error="{{addSessionError}}">
		</core-ajax>

		<!-- Edit session API call. -->
		<core-ajax id="editSessionAPI"
			url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets/' + sheet._id }}"
			method="POST"
			contentType="application/json"
			on-core-response="{{editSessionResponse}}"
			on-core-error="{{editSessionError}}">
		</core-ajax>

		<h1>{{sheet ? sheet.title : 'New Ticking Session:'}}</h1>
		<h2>Session Information</h2>
		<div layout vertical>
			<div layout horizontal start>
				<core-icon class="big" icon="keep"></core-icon>
				<paper-input id="titleInput" 
					floatingInput
					required
					value="{{sheet.title}}"
					placeholder="Ticking session title..."
					pattern="^[^/]+$"
					error="Invalid session title."
					on-input="{{validate}}"></paper-input>
			</div>

			<div layout horizontal start>
				<!-- TODO: try multiline -->
				<core-icon class="big" icon="info-outline"></core-icon>
				<paper-input id="descInput"
					value="{{desc}}"
					label="Description..."
					maxRows="5"></paper-input>
			</div>

			<div layout horizontal start>
				<core-icon class="big" icon="communication:location-on">
				</core-icon>
				<paper-input id="locInput"
					value="{{loc}}"
					floatingInput
					placeholder="Location..."></paper-input>
			</div>
		</div>

		<h2>Ticking Slot Length:</h2>
		<div layout horizontal start>
			<core-icon class="big" icon="image:timelapse"></core-icon>
			<paper-input id="slotLengthInput"
				required
				disabled?="{{sheet}}"
				on-input="{{validate}}"
				value="{{slotLengthDisplay}}"
				placeholder="In minutes..."
				pattern="^[0-9]+$"
				error="Invalid slot length.">
			</paper-input>
		</div>

		<h2>Date and Time</h2>
		<div layout horizontal start>
			<core-icon class="big" icon="event"></core-icon>
			<paper-input id="date" class="datetime"
				type="date"
				required 
				error="Session date." 
				value="{{date}}"
				on-change="{{validate}}">
			</paper-input>

			<core-icon class="big" icon="device:access-time"></core-icon>
			<paper-input id="startTime" class="datetime"
				type="time"
				required 
				error="Start time." 
				value="{{startTime}}"
				on-change="{{validate}}">
			</paper-input>

			<core-icon class="big" icon="device:access-time"></core-icon>
			<paper-input id="endTime" class="datetime"
				type="time"
				required 
				error="End time." 
				value="{{endTime}}"
				on-change="{{validate}}">
			</paper-input>
		</div>

		<h2>Tickers</h2>
		<template repeat="{{ticker in tickers}}">
			<div layout horizontal center>
				<paper-input disabled value="{{ticker}}"></paper-input>
				<paper-icon-button icon="delete" ticker="{{ticker}}" on-click="{{removeTicker}}">
				</paper-icon-button>
			</div>
		</template>

		<div layout horizontal center>
			<paper-input id="addTickerInput"
				placeholder="New ticker...">
			</paper-input>
			<paper-icon-button id="addTickerButton" icon="add"
				on-click="{{addTicker}}"></paper-icon-button>
		</div>

		<div id="buttonsContainer" layout horizontal center end-justified>
			<paper-button raisedButton id="resetButton" label="CANCEL" on-click="{{cancelClicked}}"></paper-button>
			<paper-button raisedButton id="submitButton" 
				label="{{sheet ? 'SAVE' : 'CREATE'}}" 
				disabled="{{disableSubmit}}"
				on-click="{{submitClicked}}">
			</paper-button>
		</div>


		<!-- Response toasts. -->
		<paper-toast id="addSessionSuccess" duration="8000"></paper-toast>
		<paper-toast id="addSessionError" duration="8000"></paper-toast>
		<paper-toast id="editSessionSuccess" duration="8000"></paper-toast>
		<paper-toast id="editSessionError" duration="8000"></paper-toast>

	</template>
	<script>
		Polymer('add-edit-session', {

			domReady: function () {
				if (this.sheet) {
					this.titleName = this.sheet.title;
					this.desc = this.sheet.description;
					this.loc = this.sheet.location;
					this.slotLengthDisplay = this.sheet.slotLength;

					var startDT = new Date(this.sheet.startTime).toJSON();
					var endDT = new Date(this.sheet.endTime).toJSON();
					var startT = startDT.indexOf('T');

					this.date = startDT.slice(0, startT);
					this.startTime = startDT.slice(startT + 1, startDT.lastIndexOf(':'));
					this.endTime = endDT.slice(endDT.indexOf('T') + 1, endDT.lastIndexOf(':'));

				}

				this.tickers = this.sheet ? 
					this.sheet.columns.map(function(item) {
						return item.name;
					}) : [];

				this.validate();
			},

			validate: function () {

				console.log(this.$.titleInput.inputValue && !this.$.titleInput.invalid &&
					this.tickers && this.tickers.length >= 1 &&
					this.$.date.value &&
					this.$.startTime.value && this.$.endTime.value &&
					this.$.slotLengthInput.inputValue &&
					!this.$.slotLengthInput.invalid);

				if (this.$.titleInput.inputValue && !this.$.titleInput.invalid &&
					this.tickers && this.tickers.length >= 1 &&
					this.$.date.value &&
					this.$.startTime.value && this.$.endTime.value &&
					this.$.slotLengthInput.inputValue &&
					!this.$.slotLengthInput.invalid) {
					this.disableSubmit = false;
				}
				else {
					this.disableSubmit = true;
				}
			},

			addTicker: function () {
				var s = this.$.addTickerInput.inputValue;
				if (s) {
					this.tickers.push(s);
				}
				this.validate();
			},

			removeTicker: function (e, detail, target) {
				var name = target.getAttribute('ticker');
				var i = this.tickers.indexOf(name);
				if (i > -1) {
					this.tickers.splice(i, 1);
				}
				this.validate();
			},

			submitClicked: function () {
				this.title = this.$.titleInput.inputValue;
				this.description = this.$.descInput.inputValue;
				this.location = this.$.locInput.inputValue;
				this.subStartTime = Date.parse(this.$.date.value + "T" + this.$.startTime.value);
				this.subEndTime = Date.parse(this.$.date.value + "T" + this.$.endTime.value);
				this.slotLength = this.$.slotLengthInput.inputValue;

				if (this.sheet)  {
					var call = this.$.editSessionAPI;
				}
				else {
					var call = this.$.addSessionAPI;
				}
				call.body = '{"title" : "' + this.title + '", "description" : "' + this.description + '", "location" : "' + this.location + '", "startTime" : "' + this.subStartTime + '", "endTime" : "' + this.subEndTime + '", "slotLengthInMinutes" : "' + this.slotLength + '", "tickerNames" : ' + JSON.stringify(this.tickers) + ', "groupID" : "' + this.gid + '" }';
				call.go();
			},

			addSessionResponse: function () {
				var toast = this.$.addSessionSuccess;
				toast.text = "Successfully created new ticking session '" + this.title + "'.";
				toast.show();
				this.fire('sheet-created');
			},

			addSessionError: function(e, detail) {
				var toast = this.$.addSessionError;
				toast.text = detail.xhr.responseText;
				toast.show();
			},

			cancelClicked: function () {
				this.fire('sheet-cancel');
			},

			editSessionResponse: function () {
				var toast = this.$.addSessionSuccess;
				toast.text = "Edited ticking session '" + this.title + "'.";
				toast.show();
				this.fire('sheet-edited');
			},

			editSessionError: function(e, detail) {
				var toast = this.$.editSessionError;
				toast.text = detail.xhr.responseText;
				toast.show();
			},
			
		});
	</script>
</polymer-element>