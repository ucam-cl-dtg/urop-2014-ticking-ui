<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog-transition.html">
<link rel="import" href="../bower_components/core-transition/core-transition.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="person-list.html">
<link rel="import" href="dialog.html">

<polymer-element name="group-members" attributes="gid allowAdd rows">
	<template>
		<link rel="stylesheet" type="text/css" href="../css/elements/group-members.css">

		<!-- Add Member Ajax call. -->
		<core-ajax id="addMemberAjax"
			method="POST"
			contentType="application/json"
			handleAs="json"
			url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/grouping"
			on-core-response="{{addMemberResponse}}">
		</core-ajax>

		<!-- Member list Ajax call. -->
		<core-ajax id="listAjax"
			auto
			url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/' + gid + '/users'}}"
			handleAs="json"
			on-core-response="{{listResponse}}">
		</core-ajax>


		<!-- Card heading. -->
		<div id="headerBar" layout horizontal center>
			<h1 flex>Members ({{$.members.number}})</h1>
			<template if="{{allowAdd}}">
				<paper-icon-button icon="add" on-click="{{addMemberClicked}}" core-overlay-toggle></paper-icon-button>
			</template>
		</div>

		<!-- Member list. -->
		<div id="personListContainer">
			<person-list id="members" listURL="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/' + gid + '/users'}}"></person-list>
		</div>

		<!-- Add Member dialog. -->
		<paper-dialog id="addDialog" heading="Add new member:" backdrop	
				transition="core-transition-top">
			<paper-input id="addInput" class="dialogInput"
				floatingLabel
				label="CRSid..."
				error="Invalid CRSid."
				validate="^[a-zA-Z]+\d+$"
				on-input="{{handleAddInput}}">
			</paper-input>
			<h2 class="subtitle">Roles:</h2>
			<table>
				<tr>
					<td>Author:</td><td><paper-checkbox id="authBox"></paper-checkbox></td>
					<td>Marker:</td><td><paper-checkbox id="markBox"></paper-checkbox></td>
				</tr>
				<tr>
					<td>Overview:</td><td><paper-checkbox id="overBox"></paper-checkbox></td>
					<td>Submitter:</td><td><paper-checkbox id="subBox"></paper-checkbox></td>
				</tr>
			</table>
			<template if="{{showSubmit}}">
				<paper-button id="addSubmit" class="dialogSubmit" label="ADD" on-click="{{addMember}}" affirmative></paper-button>
			</template>
		</paper-dialog>


	</template>
	<script>
		Polymer('group-members', {
			ready: function () {
			},

			addMember: function() {
				var newCRSID = this.$.addInput.value;
				var roles = [];
				if (this.$.authBox.checked) roles.push('AUTHOR');
				if (this.$.markBox.checked) roles.push('MARKER');
				if (this.$.overBox.checked) roles.push('OVERVIEW');
				if (this.$.subBox.checked) roles.push('SUBMITTER');
				this.$.addMemberAjax.body = JSON.stringify(roles);
				this.$.addMemberAjax.url += '?gid=' + this.gid + '&crsid=' + newCRSID;
				this.$.addMemberAjax.go();
			},

			handleAddInput: function () {
				if (this.$.addInput.invalid || this.$.addInput.inputValue === "") {
					this.showSubmit = false;
				}
				else {
					this.showSubmit = true;
				}
			},

			addMemberClicked: function () {
				this.$.addDialog.toggle();
			},

			listResponse: function() {
				this.$.members.people = this.$.listAjax.response;
			},

			addMemberResponse: function() {
				this.$.members.people = this.$.addMemberAjax.response;
			}
		});
	</script>
</polymer-element>