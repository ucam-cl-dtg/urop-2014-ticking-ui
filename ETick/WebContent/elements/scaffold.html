<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-selector/core-selector.html">
<link rel="import" href="menu-button.html">
<link rel="import" href="dashboard.html">
<link rel="import" href="onlogin.html">
<link rel="import" href="group.html">
<link rel="import" href="create-group.html">

<polymer-element name="page-scaffold" attributes="">
	<template>
		<link rel="stylesheet" type="text/css" href="../css/elements/scaffold.css">

	<!-- API calls. -->
	<on-login id="loginAPIs"></on-login>
	
	<a name="top"></a>

	<core-header-panel id="headerPanel">

		<!-- Main header toolbar. -->
		<core-toolbar id="headerToolbar">

			<a href="#top" id="title">Tickl</a>

			<div flex layout horizontal end-justified>
			<core-selector id="navMenu" valueattr="id" selected="dashButton" selectedAttribute="">

                <menu-button id="ticksMenu" label="Ticks" valueattr="label">
                    <template repeat="{{item in items}}">
                        <core-item icon="folder-shared" label="{{item.name}}" gid="{{item._id}}"></core-item>
                    </template>
                    <template if="{{!$.loginAPIs.ldap.isStudent}}">
                        <core-item id="createTickItem" icon="add" label="Create..."></core-item>
                    </template>
                </menu-button>

				<menu-button id="groupsMenu" label="Groups" valueattr="label">
					<template repeat="{{item in items}}">
						<core-item icon="folder-shared" label="{{item.name}}" gid="{{item._id}}" info="{{item.info}}" creator="{{item.creator}}"></core-item>
					</template>
					<template if="{{!$.loginAPIs.ldap.isStudent}}">
						<core-item id="createGroupItem" icon="add" label="Create..."></core-item>
					</template>
				</menu-button>

				<paper-button id="dashButton" label="DASHBOARD"></paper-button>

			</core-selector>
			</div>

			<div layout horizontal end-justified>
				<div>
					<paper-button icon="exit-to-app" id="logoutButton" on-click="{{logoutClicked}}"></paper-button>
				</div>
			</div>
		</core-toolbar>

		<!-- Create new group element. -->
		<create-group id="createGroup" on-group-created="{{groupCreatedHandler}}"></create-group>

		<!-- Page content cards. -->
		<template id="dashTemp" if="{{showDash}}">
			<user-dash id="dash"></user-dash>
		</template>

		<template id="groupTemp" if="{{gid}}">
			<x-group gid="{{gid}}" name="{{name}}" info="{{info}}" creator="{{creator}}"></x-group>
		</template>

	</core-header-panel>
	</template>
	<script>
		Polymer('page-scaffold', {

			toSelect: "-1",

			observe: {
				'$.groupsMenu.selection': 'groupSelectionChanged',
                '$.ticksMenu.selection': 'tickSelectionChanged',
				'$.navMenu.selection': 'navSelectionChanged',
				'$.loginAPIs.groupItems' : 'groupItemsChanged'
			},

			navSelectionChanged: function(oldValue, newValue) {
				if (newValue.id === "dashButton") {
					this.showDash = true;
					this.$.groupTemp.model = {gid: null};
					this.$.groupsMenu.selected = "-1";
				}
			},

			logoutClicked: function () {
				this.$.loginAPIs.$.logoutAjax.go();
		    	window.location.href = 'https://raven.cam.ac.uk/auth/logout.html';
			},

			groupSelectionChanged: function (oldValue, newValue) {
				if (!newValue || (oldValue && oldValue.id === "createGroupItem")) return;
				if (newValue.id === "createGroupItem") {
					this.$.createGroup.toggleDialog();
					this.$.groupsMenu.selected = oldValue ? oldValue.label : "-1";
				}
				else {
					this.showDash = false;
					this.$.groupTemp.model = {gid: null};
					this.$.groupTemp.model = { 
						gid: newValue.getAttribute('gid'),
						name: newValue.label,
						info: newValue.getAttribute('info'),
						creator: newValue.getAttribute('creator')
					};
				}
			},

            tickSelectionChanged: function (oldValue, newValue) {
                if (!newValue || (oldValue && oldValue.id === "createTickItem")) return;

                this.showDash = false;
                if (newValue.id === "createTickItem") {
                    //this.$.createGroup.toggleDialog();
                    //this.$.groupsMenu.selected = oldValue ? oldValue.label : "-1";
                }
                else {
                    this.$.groupTemp.model = {gid: null};
                    this.$.groupTemp.model = {gid: newValue.getAttribute('gid')};
                }
            },

			groupCreatedHandler: function (e, detail) {
				this.$.loginAPIs.$.sidebarAjax.go();
				this.toSelect = detail.name;

				this.showDash = false;
			},

			groupItemsChanged: function (oldValue, newValue) {
				this.items = newValue;

				// No idea why this works, but it's here for browser compatability with Firefox.
				setTimeout(function () {
					this.$.groupsMenu.selected = this.toSelect
				}.bind(this), 0);
			}

		});
	</script>
</polymer-element>