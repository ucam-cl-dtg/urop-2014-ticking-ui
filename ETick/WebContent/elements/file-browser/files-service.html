<!-- vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab textwidth=72 : -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<polymer-element name="files-service"
    attributes="date
                files
                errors
                tickId
                comments
                commitId
                repoName
                testCount
                testResult
                tickerResult
                reportResult">
  <template>
    <style>
    :host {
      display: none;
    }
    </style>
    <core-ajax id="report"
               auto
               on-core-response="{{reportLoaded}}"
               handleAs="json">
    </core-ajax>
    <core-ajax id="fileContent"
               auto
               on-core-response="{{filesLoaded}}"
               handleAs="json">
    </core-ajax>
  </template>
  <script src="../../hardcoded.js"></script>
  <script>
  Polymer('files-service'
    , {   repoNameChanged:
          function ()
          {
            "use strict";

            this.$.report.url =
              /* TODO: Use ticker service */
              ticker_service + "/submission/" + this.tickId + "/last";

          }

        , reportLoaded:
          function()
          {
            "use strict";

            if (typeof this.$.report.response != typeof Object())
            {
              this.testResult = "FAIL";
              this.tickerResult = "FAIL";
              this.reportResult = "FAIL";
              this.testResult = "FAIL";
              this.errors = [];
              this.files =
                [{   "name": "Error"
                   , "content": "Failed to load report!"
                }]
                this.fire('files-loaded');

                return;
            }
            /* Load files, fires due to auto attribute */
            this.$.fileContent.url =
              /* TODO: Use ticker service */
              git_service + "/bundle/"
              + this.$.report.response.repoName + ".git/"
              + this.$.report.response.commitId;

            /* Make a copy of the loaded data */
            this.testResult   = this.$.report.response.testResult;
            this.tickerResult = this.$.report.response.tickerResult;
            this.reportResult = this.$.report.response.reportResult;
            this.comments     = this.$.report.response.tickerComments;
            this.errors       = this.$.report.response.items;
            this.commitId     = this.$.report.response.commitId;
            this.date         = this.$.report.response.creationDate;
            this.testCount    = this.$.report.response.noOfTests;

            var i;
            for (i = 0; i < this.errors.length; i++)
            {
              this.errors[i].id = i;
            }
          }

        , filesLoaded:
          function ()
          {
            "use strict";

            this.files = this.$.fileContent.response;

            var i;
            for (i = 0; i < this.files.length; i++)
            {
              this.files[i].id = i;
            }

            this.fire('files-loaded');
          }
      });
  </script>
</polymer-element>
