<!-- vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab textwidth=72 : -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<polymer-element name="files-service"
    attributes="date
                files
                crsid
                errors
                tickId
                comments
                commitId
                repoName
                testCount
                testResult
                tickerResult
                reportResult
                reportCreationDate">
  <template>
    <link rel="stylesheet" href="../../css/shared-styles.css"/>
    <toast-ajax id="report"
                on-core-response="{{reportLoaded}}"
                handleAs="json"
                method="GET"
                auto
                
                popUpError
                captureError
                waitMessage="Loading report...."
                responseMessage="Report successfully loaded.">
    </toast-ajax>
    <toast-ajax id="fileContent"
                on-core-response="{{filesLoaded}}"
                handleAs="json"
                method="GET"
                
                popUpError
                captureError
                waitMessage="Loading files...."
                responseMessage="Files successfully loaded.">
    </toast-ajax>
  </template>
  <script src="../../hardcoded.js"></script>
  <script>
  Polymer('files-service'
    , {   repoNameChanged:
          function ()
          {
            "use strict";

            if (typeof this.crsid == typeof undefined
              ||this.crsid == null)
            {
              this.$.report.url =
                ticking_service + "/submission/" + this.tickId + "/last";
            }
            else
            {
              this.$.report.url =
                ticking_service + "/submission/" + this.tickId + "/last"
                + "?crsid=" + this.crsid;
            }

          }

        , reportLoaded:
          function()
          {
            "use strict";

            if (typeof this.$.report.response != typeof Object())
            {
              this.testResult = "FAIL";
              this.tickerResult = "FAIL";
              this.reportResult = "FAIL";
              this.testResult = "FAIL";
              this.errors = [];
              this.files =
                [{   "name": "Error"
                   , "content": "Failed to load report!"
                }]
                this.fire('files-loaded');

                return;
            }
            /* Load files, fires due to auto attribute */
            if (typeof this.crsid == typeof undefined
              ||this.crsid == null)
            {
              this.$.fileContent.url =
                ticking_service + "/fork/"
                + this.tickId + "/"
                + this.$.report.response.commitId
                + "/files";
            }
            else
            {
              this.$.fileContent.url =
                ticking_service + "/fork/"
                + this.tickId + "/"
                + this.$.report.response.commitId
                + "/files?crsid="
                + this.crsid;
            }
            this.$.fileContent.go();

            /* Make a copy of the loaded data */
            this.testResult   = this.$.report.response.testResult;
            this.tickerResult = this.$.report.response.tickerResult;
            this.reportResult = this.$.report.response.reportResult;
            this.comments     = this.$.report.response.tickerComments;
            this.errors       =
              this.$.report.response.items.reduce(
                  function (prev, curr)
                  {
                    curr.className = curr.outcome + prev.length;
                    return prev.concat(curr);
                  }, []);
            this.commitId     = this.$.report.response.commitId;
            this.date         = new Date(this.$.report.response
                                                    .creationDate);
            this.testCount    = this.$.report.response.noOfTests;
          }

        , filesLoaded:
          function ()
          {
            "use strict";

            this.files = this.$.fileContent.response;

            var i;
            for (i = 0; i < this.files.length; i++)
            {
              this.files[i].id = i;
            }

            this.fire('files-loaded');
          }
      });
  </script>
</polymer-element>
