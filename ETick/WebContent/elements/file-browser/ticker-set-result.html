<!-- vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab textwidth=72 : -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../bower_components/core-input/core-input.html"/>
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html"/>
<link rel="import" href="../confirm-button/confirm-button.html"/>

<polymer-element name="ticker-set-result"
                 attributes="crsid
                             ticker
                             tickId
                             sheetId
                             repoName
                             commitId
                             reportCreationDate">
  <template>
    <link rel="stylesheet" href="../../css/shared-styles.css"/>
    <link rel="stylesheet" href="button-style.css"/>
    <link rel="stylesheet" href="ticker-set-result-style.css"/>

    <toast-ajax id="setTickResult"
               method="PUT"
               contentType="application/json"

               popUpError
               captureError
               popUpResponse
               waitMessage="Marking tick...."
               responseMessage="Tick for {{crsid}} marked as {{tickStatus}}.">
    </toast-ajax>

    <toast-ajax id="setNoShow"
               method="DELETE"
               contentType="application/json"

               popUpError
               captureError
               popUpResponse
               waitMessage="Unbooking {{crsid}}'s sign-ups.... "
               responseMessage="Student {{crsid}} unsigned due to not showing up.">
    </toast-ajax>

    <div class="top">
      <core-input id="tickerComment"
                  multiline
                  class="input"
                  rows="3"
                  placeholder="Enter comments here.">
      </core-input>
    </div>
    <div class="bottom">
      <confirm-button yesBgColor="#455ede"
                      noBgColor="#91a7ff">
        <paper-button raisedButton
                      id="pass"
                      class="spaced wide green"
                      label="PASS"
                      on-tap="{{passTick}}">
        </paper-button>
        <paper-button raisedButton
                      id="fail"
                      class="spaced wide red"
                      label="FAIL"
                      on-tap="{{failTick}}">
        </paper-button>
        <paper-button raisedButton
                      id="noShow"
                      class="spaced wide bluegrey"
                      label="NO SHOW"
                      on-tap="{{noShow}}">
        </paper-button>
      <confirm-button>
    </div>
  </template>
  <script src="../../js/hardcoded.js"></script>
  <script>
    Polymer('ticker-set-result'
      , {   tickStatus: null
          , sure: false
          , sendTick:
            function (tickStatus, comment)
            {
              "use strict";

              if (typeof comment == typeof undefined)
              {
                comment = null;
              }
              else
              {
                comment = comment.replace(/\n/gm, "\\n")
                                 .replace(/\'/gm, "\\'")
                                 .replace(/\"/gm, '\\"')
                                 .replace(/\&/gm, "\\&")
                                 .replace(/\r/gm, "\\r")
                                 .replace(/\t/gm, "\\t")
                                 .replace(/[\b]/gm, "\\b")
                                 .replace(/\f/gm, "\\f");
              }

              this.$.setTickResult.url =
                ticking_service + "/fork/"
                  + this.crsid + "/"
                  + this.tickId + "/";

              this.$.setTickResult.body =
                  '{   "humanPass"      : "' + tickStatus + '"\n'
                + '  , "signedUp"       : false\n'
                + '  , "tickerComments" : "' + comment + '"\n'
                + '  , "commitId"       : "' + this.commitId + '"\n'
                + '  , "ticker"         : "' + this.ticker + '"\n'
                + '  , "reportDate"     : "' +
                    this.reportCreationDate.toISOString() + '"\n'
                + '}'

              this.$.setTickResult.go();
            }

          , passTick:
            function (e)
            {
              var confirmElement = e.srcElement.parentElement;
              if (confirmElement.sure &&
                  confirmElement.currentConfirm == e.srcElement)
              {
                this.sendTick(true,  this.$.tickerComment.value);
                this.tickStatus = "passed";
                this.fire("tick-passed",{});
              }
            }

          , failTick:
            function (e)
            {
              var confirmElement = e.srcElement.parentElement;
              if (confirmElement.sure &&
                  confirmElement.currentConfirm == e.srcElement)
              {
                this.sendTick(false, this.$.tickerComment.value);
                this.tickStatus = "failed";
                this.fire("tick-failed",{});
              }
            }

          , noShow:
            function (e)
            {
              var confirmElement = e.srcElement.parentElement;
              if (confirmElement.sure &&
                  confirmElement.currentConfirm == e.srcElement)
              {
                this.$.setNoShow.url = ticking_service +
                      "/signups/students/" + this.crsid
                      + "/bookings/" + this.sheetId;
                this.$.setNoShow.go();
                this.fire("tick-no-show",{});
              }
            }
        });
  </script>
</polymer-element>
