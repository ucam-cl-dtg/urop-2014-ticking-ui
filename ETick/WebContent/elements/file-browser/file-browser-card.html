<!-- vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab textwidth=72 : -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/core-splitter/core-splitter.html"/>
<link rel="import" href="../../bower_components/marked-element/marked-element.html"/>
<link rel="import" href="files-service.html"/>
<link rel="import" href="file-card.html"/>
<link rel="import" href="files-list.html"/>
<link rel="import" href="status-list.html"/>
<link rel="import" href="ticker-set-result.html"/>

<!-- This is the main card for file-browsing.
  The mandatory attributes are repoName, tickId.
  The optional attributes are sheetId, crsid, ticker.
  These must be supplied together, if they are supplied.
  If they are supplied, this card also becomes a pass/fail card.
-->
<polymer-element name="file-browser-card"
                 attributes="repoName
                             sheetId
                             tickId
                             crsid
                             ticker">
  <!-- TODO: get ALL reports -->
  <template>
    <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="file-browser-style.css"/>
    <files-service id="service"
                   date="{{date}}"
                   crsid="{{crsid}}"
                   files="{{files}}"
                   errors="{{errors}}"
                   tickId="{{tickId}}"
                   repoName="{{repoName}}"
                   comments="{{comments}}"
                   commitId="{{commitId}}"
                   testCount="{{testCount}}"
                   testResult="{{testResult}}"
                   tickerResult="{{tickerResult}}"
                   reportResult="{{reportResult}}">
    </files-service>
    <div class="container" horizontal layout>
      <div class="sidebar">
        <p class="result">
          You have {{reportResult=="FAIL" || testResult=="FAIL" ? "failed." : "passed!"}}
        </p>
        <files-list files="{{files}}"
                    selectedFileId="{{selectedFileId}}">
        </files-list>
        <hr/>
        <status-list errors="{{errors}}" highlight="{{highlight}}">
        </status-list>
      </div>
      <core-splitter direction="left"></core-splitter>
      <div class="main">
        <!-- Ticker comments -->
        <template if="{{comments != null}}">
          Ticker comments:
          <!-- Indentation due to marked element considering spaces -->
          <marked-element
              class="ticker-comments">
{{comments}}
          </marked-element>
        </template>

        <!-- File contents -->
        <template repeat="{{file in files}}">
          <section id="file{{file.id}}" name="file{{file.id}}">
          <file-card content="{{file.content}}"
                     name="{{file.name}}"
                     id="{{file.id}}"
                     comments="{{errors}}"
                     highlight="{{highlight}}"
                     syntaxStyleSheet="{{syntaxStyleSheet}}">
          </file-card>
          </section>
        </template>

        <!-- Pass/fail button -->
        <template if="{{ticker != undefined}}">
          <ticker-set-result commitId="{{commitId}}"
                             crsid="{{crsid}}"
                             ticker="{{ticker}}"
                             tickId="{{tickId}}"
                             sheetId="{{sheetId}}"
                             reportCreationDate="{{date}}"
                             on-main-card-swipe-away="{{swipeAway}}"
                             on-tick-passed="{{tickPassed}}"
							 on-tick-failed="{{tickFailed}}" 
							 on-tick-no-show="{{tickNoShow}}">
          </ticker-set-result>
        </template>

      </div>
    </div>

  </template>
  <script>
    Polymer('file-browser-card'
      , {   syntaxStyleSheet: "default"
          , selectedFileIdChanged:
            function ()
            {
              var element = 
                this.shadowRoot
                  .getElementById(this.selectedFileId);
              window.scroll(element.offsetLeft, element.offsetTop);
            }
          , swipeBack:
            function ()
            {
              this.fire("main-card-swipe-back", {"card":this});
            }
  		  , updateTickerView:
  		    function()
  			{
  			  this.fire("main-card-swipe-away", {"card":this});
  			  this.fire("update-ticker-viewer", {"result": this.result});
  			}
  		  , tickPassed:
  		    function()
  			{
  			  this.result = "pass";
  			  this.updateTickerView();
  			}
  		  , tickFailed:
  		    function()
  			{
  			  this.result = "fail";
  			  this.updateTickerView();
  			}
  		  , tickNoShow:
  		    function()
  			{
  			  this.result = "noShow";
  			  this.updateTickerView();
  			}
        });
  </script>
</polymer-element>
