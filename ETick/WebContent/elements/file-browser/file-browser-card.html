<!-- vim: set shiftwidth=2 tabstop=2 softtabstop=2 expandtab textwidth=72 : -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/core-splitter/core-splitter.html"/>
<link rel="import" href="../../bower_components/core-dropdown/core-dropdown.html"/>
<link rel="import" href="../../bower_components/core-item/core-item.html"/>
<link rel="import" href="../../bower_components/marked-element/marked-element.html"/>
<link rel="import" href="files-service.html"/>
<link rel="import" href="file-card.html"/>
<link rel="import" href="files-list.html"/>
<link rel="import" href="status-list.html"/>
<link rel="import" href="ticker-set-result.html"/>

<!-- This is the main card for file-browsing.
  The mandatory attributes are repoName, tickId (lastTickedBy and
  lastTickedOn too, if the following optional ones not provided).
  The optional attributes are sheetId, crsid, ticker.
  These must be supplied together, if they are supplied.
  If they are supplied, this card also becomes a pass/fail card.
-->
<polymer-element name="file-browser-card"
                 attributes="repoName sheetId tickId crsid ticker
                             lastTickedBy lastTickedOn">
  <!-- TODO: get ALL reports -->
  <template>
    <link rel="stylesheet" href="../../css/shared-styles.css"/>
    <link rel="stylesheet" href="file-browser-style.css"/>
    <files-service id="service"
                   date="{{date}}"
                   crsid="{{crsid}}"
                   files="{{files}}"
                   errors="{{errors}}"
                   tickId="{{tickId}}"
                   repoName="{{repoName}}"
                   comments="{{comments}}"
                   commitId="{{commitId}}"
                   testCount="{{testCount}}"
                   testResult="{{testResult}}"
                   reportsList="{{reportsList}}"
                   tickerResult="{{tickerResult}}"
                   reportResult="{{reportResult}}"
                   selectedReport="{{selectedReport}}">
    </files-service>
    <div class="container" horizontal layout>
      <div class="sidebar">
        <h3 id="resultString" class="result">
        </h3>
        <files-list files="{{files}}"
                    selectedFileId="{{selectedFileId}}">
        </files-list>
        <hr/>
        <status-list errors="{{errors}}" highlight="{{highlight}}">
        </status-list>
      </div>
      <core-splitter direction="left"></core-splitter>
      <div class="main">

        <!-- Report selection -->
        <core-dropdown id="reportSelector"
                       selected="{{selectedReport}}">
          <template repeat="{{report in reportsListString}}">
            <core-item label="{{report}}"></core-item>
          </template>
        </core-dropdown>
        <br/>

        <!-- Ticker comments -->
        <template if="{{comments != null}}">
          <div class="ticker-comments">
            Ticker comments:
            <!-- Indentation due to marked element considering spaces -->
            <marked-element text="{{comments}}">
            </marked-element>
          </div>
        </template>

        <!-- File contents -->
        <template repeat="{{file in files}}">
          <section id="file{{file.id}}" name="file{{file.id}}">
          <file-card content="{{file.content}}"
                     name="{{file.name}}"
                     comments="{{errors}}"
                     highlight="{{highlight}}">
          </file-card>
          </section>
        </template>

        <!-- Pass/fail button -->
        <template if="{{ticker != undefined}}">
          <ticker-set-result commitId="{{commitId}}"
                             crsid="{{crsid}}"
                             ticker="{{ticker}}"
                             tickId="{{tickId}}"
                             sheetId="{{sheetId}}"
                             reportCreationDate="{{date}}"
                             on-tick-passed="{{tickPassed}}"
                             on-tick-failed="{{tickFailed}}" 
                             on-tick-no-show="{{tickNoShow}}">
          </ticker-set-result>
        </template>

      </div>
    </div>

  </template>
  <script src="../../js/prettyDate.js"></script>
  <script src="../../bower_components/moment/moment.js"></script>
  <script>
    Polymer('file-browser-card'
      , {   selectedFileIdChanged:
            function ()
            {
              var element = 
                this.shadowRoot
                  .getElementById(this.selectedFileId);
              window.scroll(element.offsetLeft, element.offsetTop);
            }

  		  , updateTickerView:
  		    function(reason)
  			{
  			  this.fire("hide-report", {"result": reason});
  			}
  		  , tickPassed:
  		    function()
  			{
  			  this.updateTickerView("pass");
  			}
  		  , tickFailed:
  		    function()
  			{
  			  this.updateTickerView("fail");
  			}
  		  , tickNoShow:
  		    function()
  			{
  			  this.updateTickerView("noShow");
  			}

        , getTickURL:
          function ()
          {
            if (this.crsid == null)
            {
              crsid = this.repoName.split("/")[0];
            }
            else
            {
              crsid = this.crsid;
            }

            return standalone_tick_view +
              "?repoName=" + encodeURIComponent(this.repoName) +
              "&crsid=" + encodeURIComponent(crsid) +
              "&tickId=" + encodeURIComponent(this.tickId) +
              "&lastTickedBy=" + encodeURIComponent(this.lastTickedBy) +
              "&lastTickedOn=" + encodeURIComponent(this.lastTickedOn);
          }

        , recalculateResult:
          function ()
          {
            if (this.testResult == "FAIL")
            {
              this.$.resultString.innerHTML =
                "You have failed the automatic tests." +
                " See below for more detailed information."
            }
            else if (this.tickerResult == "UNDEFINED")
            {
              this.$.resultString.innerHTML =
                "You have passed the automatic tests." +
                " Time to get this ticked!";
            }
            else if (this.tickerResult == "FAIL"
                   &&typeof this.lastTickedBy != typeof undefined
                   &&typeof this.lastTickedOn != typeof undefined)
            {
              this.$.resultString.innerHTML =
                "You have been failed by ticker " +
                  "<a href=\"mailto:" +
                    this.lastTickedBy + "@cam.ac.uk" +
                    "?subject=" +
                      encodeURIComponent("[Tickl] Question about tick " +
                          this.tickId) +
                    "&body=" +
                      encodeURIComponent("Hi,\n\nI have a question " +
                          "about why you failed my submission (" +
                          "online at: " + this.getTickURL() + ").") +
                  "\">" +
                    this.lastTickedBy +
                  "</a>" +
                " at " +
                prettyDateTime(prettyParse(this.lastTickedOn)) +
                ".";
            }
            else if (this.tickerResult == "FAIL")
            {
              this.$.resultString.innerHTML =
                "You have been failed by a ticker";
            }
            else
            {
              this.$.resultString.innerHTML = "You have passed!";
            }
          }

        , testResultChanged: function () { this.recalculateResult(); }
        , tickerResultChanged: function () { this.recalculateResult(); }
        , reportResultChanged: function () { this.recalculateResult(); }

        , reportsListChanged:
          function ()
          {
            this.reportsListString =
              this.reportsList.map(
                  function (obj)
                  {
                    return "Commit " + obj.commit.slice(0,7) +
                      ", report generated " +
                      prettyDateTime(obj.date);
                  });
            this.$.reportSelector.selected =
              this.reportsListString.length - 1;
          }
        });
  </script>
</polymer-element>
