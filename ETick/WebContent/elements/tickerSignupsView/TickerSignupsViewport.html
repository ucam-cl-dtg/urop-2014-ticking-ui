<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-icons/communication-icons.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<link rel="import" href="../are-you-sure.html">
<link rel="import" href="student-info.html">

<polymer-element name="ticker-signups-viewport" attributes="sessionId studentMode description location crsId tickId repoName ticker slotId">
  <template>
    <style>
	    :host {
	      background-color: white;
	      padding: 10px;
	      font-size: 1.2rem;
		  color: black;
	      font-weight: 300;
	      display: block;
	    }
	    #card-header {
	    	margin-bottom: 10px;
	    }
		#listTemplate:nth-child(even) {
			background:#e9e9e9;
		}
		#listTemplate:nth-child(odd) {
			background:#f6f6f6;
		}
		core-icon {
			margin-right: 10px;
		}
		.infoFieldContainer {
			margin-bottom: 10px;
		}
		#slots-view-panel {
			border: black solid 1px;
			border-bottom-style: none;
		}
    </style>
	
	<!-- Get tickers for this session -->
	<toast-ajax
		id="ajaxLoadTickers"
        url="{{pathLoadTickers}}"
		waitMessage="Loading tickers..."
		captureError
		waitBeforeToast="1000"
        handleAs="json"
		contentType="application/json"
        on-core-response="{{tickersDataLoaded}}">
	</toast-ajax>

	<!-- Get slots for this session and ticker -->
    <toast-ajax
		id="ajaxLoadSlots"
        url="{{pathLoadSlots}}"
		waitMessage="Loading slots..."
		captureError
		waitBeforeToast="1000"
        handleAs="json"
		contentType="application/json"
        on-core-response="{{slotsDataLoaded}}">
	</toast-ajax>
	
	<!-- Kick someone out of a slot -->
    <core-ajax
		id="ajaxKick"
        url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/students/{{crsId}}/ticks/{{tickId}}"
		method = "DELETE"
		contentType="application/json"
		handleAs="text"
		on-core-response="{{kickDone}}" >
	</core-ajax>
	
	<div layout vertical>
		<div id="card-header" layout vertical>
			<div class="infoFieldContainer" layout horizontal center>
				<core-icon icon="communication:location-on"></core-icon>
				<span>{{locationDisplayed}}</span>
			</div>
			<div class="infoFieldContainer" layout horizontal center>
				<core-icon icon="event"></core-icon>
				<span>Date: {{date}}</span>
			</div>
			<div class="infoFieldContainer" layout horizontal start>
				<core-icon icon="info-outline"></core-icon>
				<span flex>{{descriptionDisplayed}}</span>
			</div>
		</div>
		<div id="ticker-select-panel" align="center">
			<paper-radio-group selected="{{selected}}" on-change="{{tickerChange}}" layout horizontal flex>
				<template repeat="{{ticker in tickers}}">
					<paper-radio-button label="{{ticker.name}}" flex></paper-radio-button>
				</template>
			</paper-radio-group>
		</div>
		<div id="slots-view-panel">
				<template repeat="{{slot in slots}}">
					<span layout vertical id="listTemplate" style="border-bottom: black solid 1px;">
						<span layout horizontal flex>
							<div align="center" style="min-width:60px">
								<core-icon-button hidden?="{{((slot.hidden)||(studentMode))}}" on-tap="{{toggleInfo}}" align="center" id="{{slot._id}}" icon="{{slot.collapse ? 'expand-less' : 'expand-more'}}"></core-icon-button>
								<core-icon hidden?="{{!studentMode}}" icon="chevron-right"></core-icon>
							</div>
							<div align="left" layout horizontal center flex three>
									<div hidden?="{{slot.outcome != 'null'}}">
											<core-item label="{{slot.student=='' ? slot.timeStamp + '  Empty Slot' : slot.timeStamp + '  crsid : ' + slot.student + ' ,  tick : ' + slot.comment}}" style="min-height:20px" span></core-item>
									</div>
									<div hidden?="{{slot.outcome == 'null'}}">
										<core-item label="{{slot.timeStamp}}  crsid : {{slot.student}}  ,  tick :  {{slot.comment}} , outcome : {{slot.outcome}}" style="min-height:20px" span></core-item>
									</div>
							</div>
							<div hidden?="{{((slot.hidden)||(studentMode))}}" flex>
								<span>View Report</span>
								<core-icon-button on-tap="{{getReport}}" label="View Report" align="right" id="{{slot._id}}" icon="archive"></core-icon-button>
							</div>
							<div hidden?="{{((slot.hidden)||(studentMode))}}" flex>
								<span>Remove {{slot.student}} from Slot</span>
								<core-icon-button on-tap="{{kick}}" label="Remove {{slot.student}} from Slot" align="left" id="{{slot._id}}" icon="exit-to-app"></core-icon-button>
							</div>
						</span>
						<div>
							<core-collapse opened?="{{slot.collapse}}">
								<div>
									<student-info crsId="{{slot.student}}" opened="{{slot.collapse}}"></student-info>
								</div>
							</core-collapse>
						</div>
					</span>
				</template>
		</div>
	</div>
	
  </template>
  <script src="../../js/prettyDate.js"></script>
  <script src="../../bower_components/moment/moment.js"></script>
  <script>
  Polymer('ticker-signups-viewport', {
			refresh: function() {
				this.fire("hide-report");
				this.pathLoadTickers = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets/" + this.sessionId;
				if (this.location === "") {
					this.locationDisplayed = "Location: No location is available";
				}
				else {
					this.locationDisplayed = "Location: " + this.location;
				}
				if (this.description === "") {
					this.descriptionDisplayed = "Description: No description is available";
				}
				else {
					this.descriptionDisplayed = "Description: " + this.description;
				}
				this.$.ajaxLoadTickers.go();
			},
			tickersDataLoaded: function() {
				var loadedTickers = this.$.ajaxLoadTickers.response.slice(0);
				this.tickers = [];
				for (var i = 0; i < loadedTickers.length; i++) {
					this.tickers.push({name: loadedTickers[i].name});
				}
				this.selected = 0;
				this.ticker = this.tickers[0].name;
			},	
			slotsDataLoaded: function() {
				var loadedSlots = this.$.ajaxLoadSlots.response.slice(0);
				this.slots = [];
				for (var i = 0; i < loadedSlots.length; i++) {

                    var slotTime = prettyParse(loadedSlots[i].startTime);
                    var hour = prettyTime(slotTime).split(":")[0];
					var min =  prettyTime(slotTime).split(":")[1];

					var timeSlot = hour + ":" + min;

					/* check this conversion is right */
					var durationInMinutes = loadedSlots[i].duration/60000;
					var student = loadedSlots[i].bookedUser;
					var comment = loadedSlots[i].comment;
					var hidden = false;
					if(student === undefined || student===null) {
						student = "";
						comment = "Empty Slot";
						hidden = true;
					}

					/* sort out leading zero */
					var endMin = parseInt(min) + parseInt(durationInMinutes);
					var endHour = parseInt(hour) +
                        parseInt(Math.floor(durationInMinutes/60));

					while (endMin >= 60) {
						endMin = endMin%60;
						endHour++;
					}

					var leadingZero = "";
					if (endMin < 10) {
						leadingZero = "0";
					}

					var past = false;
					var current = false;
					if (slotsYear < this.year) {
						past = true;
					}
					else if (slotsYear === this.year) {
						if(slotsMonth < this.month) {
							past = true;
						}
						else if (slotsMonth === this.month) {
							if(slotsDay < this.day) {
								past = true;
							}
							else if(slotsDay === this.day) {
								if( endHour < this.hours ){
									past = true;
								}
								else if (endHour === this.hours) {
									if (endMin <= this.minutes) {
										past = true;
									}
									else if ((endMin != 0) && (this.minutes >= parseInt(min)) && (this.minutes < endMin)) {
										current = true;
									}
								}
								else if (endHour === this.hours+1) {
									if (endMin === 0) {
										if ((this.minutes >= parseInt(min)) && (this.minutes < 60)) {
											current = true;
										}
									}
								}
							}
						}
					}
					var timeStamp = hour + ":" + min + " - " + endHour + ":" + leadingZero + endMin;
					this.slots.push({_id: loadedSlots[i]._id , duration: durationInMinutes , student: student, comment: comment,
									 time : timeSlot, timeStamp: timeStamp, hidden : hidden, outcome: "null", collapse: false, inPast: past, currentSlot: current});
				}
				this.date = prettyDate(prettyParse(loadedSlots[0].startTime));
			},
			tickerChange: function(event) {
				if(event.target.checked) {
					this.ticker = event.target.label;
					this.pathLoadSlots = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets/" + this.sessionId + "/tickers/" + this.ticker;
					this.$.ajaxLoadSlots.go();
					this.fire("hide-report");
				}
			},
			updateViewConsole: function(newResult) {
				if(newResult != undefined) {
					//Wait for signups API to allow update
					console.log(newResult + " " + this.slotId);
					this.$.ajaxLoadSlots.go();
					this.slotId = undefined;
				}
				//else already passed/failed and something went wrong - can hide buttons once API is up to date
			},
			toggleInfo: function(event) {
				var slotId = event.target.id;
				for(i=0;i<this.slots.length;i++) {
					if(this.slots[i]._id === slotId) {
						this.slots[i].collapse = !this.slots[i].collapse;
						break;
					}
				}
			},
			getReport : function(event) {
				this.slotId = event.target.id;
				var slotId = event.target.id;
				for(i=0;i<this.slots.length;i++) {
					if(this.slots[i]._id === slotId) {
						this.crsId = this.slots[i].student;
						this.tickId = this.slots[i].comment;
						this.repoName = this.crsId + "/" + this.tickId.replace(",","/");
						break;
					}
				}
				this.fire("show-report");
			},
			kick : function(event) {
				this.slotId = event.target.id;
				var slotId = event.target.id;
				for(i=0;i<this.slots.length;i++) {
					if(this.slots[i]._id === slotId) {
						this.crsId = this.slots[i].student;
						this.tickId = this.slots[i].comment;
						break;
					}
				}
				this.fire("open-are-you-sure");
			},
			kickForSure : function() {
				this.$.ajaxKick.go();
			},
			kickDone : function() {
				this.$.ajaxLoadSlots.go();
			}
		})
  </script>
</polymer-element>
