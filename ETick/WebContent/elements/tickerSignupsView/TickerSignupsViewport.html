<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">

<polymer-element name="ticker-signups-viewport" attributes="sessionId description location crsId tickId repoName ticker">
  <template>
    <style>
    :host {
      background-color: white;
      padding: 10px;
      width: 100%;
      font-size: 1.2rem;
	  color: black;
      font-weight: 300;
    }
    .card-header {
	  padding-top: 5px
      margin-bottom: 10px;
    }
    </style>
	
	<!-- Get tickers for this session -->
    <core-ajax
        id="ajaxLoadTickers"
        url="{{pathLoadTickers}}"
        handleAs="json"
		contentType="application/json"
        on-core-response="{{tickersDataLoaded}}"
        on-core-error="{{alertError}}">
    </core-ajax>
	
	<!-- Get slots for this session and ticker -->
    <core-ajax
        id="ajaxLoadSlots"
        url="{{pathLoadSlots}}"
        handleAs="json"
		contentType="application/json"
        on-core-response="{{slotsDataLoaded}}"
        on-core-error="{{alertError}}">
    </core-ajax>
	
	<div layout vertical>
		<div id="card-header" align="left">
			<core-item icon="home" label="{{location}}"></core-item>
			<core-item icon="today" label="Date : {{date}}"></core-item>
			<core-item icon="info" label="{{description}}"></core-item>
			<!-- would it be possible for class to contain date of session too? -->
		</div>
		<div id="ticker-select-panel" align="center">
			<paper-radio-group selected="{{selected}}" on-change="{{tickerChange}}" layout horizontal flex>
				<template repeat="{{ticker in tickers}}">
					<paper-radio-button label="{{ticker.name}}" flex></paper-radio-button>
				</template>
			</paper-radio-group>
		</div>
		<div id="slots-view-panel" align="center">
				<template repeat="{{slot in slots}}">
					<span layout horizontal center style="border:black solid 1px" flex>
						<div align="left" flex three>
							<core-item label="{{slot.student=='' ? slot.timeStamp + '  Empty Slot' : slot.timeStamp + '  crsid : ' + slot.student + ' ,  tick : ' + slot.comment}}" style="min-height:20px" span></core-item>
						</div>
						<div hidden?="{{slot.hidden}}" flex>
							<span>View Report</span>
							<core-icon-button on-tap="{{getReport}}" label="View Report" align="right" id="{{slot._id}}" icon="archive" size="1"></core-icon-button>
						</div>
					</span>
				</template>
		</div>
	</div>
	
  </template>
  <script>
  Polymer('ticker-signups-viewport', {
			ready: function() {
			},
			refresh: function() {
				this.crsId = "";
				this.tickId = "";
				this.repoName = "";
				this.pathLoadTickers = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets/" + this.sessionId;
				if (this.location === "Location : undefined") {
					this.location = "Location : No location is available";
				}
				if (this.description === "Description : undefined") {
					this.description = "Description : No description is available";
				}
				this.$.ajaxLoadTickers.go();
			},
			tickersDataLoaded: function() {
				var loadedTickers = this.$.ajaxLoadTickers.response.slice(0);
				this.tickers = [];
				for (var i = 0; i < loadedTickers.length; i++) {
					this.tickers.push({name: loadedTickers[i].name});
				}
				this.selected = 0;
				this.ticker = this.tickers[0].name;
			},	
			slotsDataLoaded: function() {
				var loadedSlots = this.$.ajaxLoadSlots.response.slice(0);
				this.slots = [];
				for (var i = 0; i < loadedSlots.length; i++) {
					var hour = loadedSlots[i].startTime.split(":")[0].split("T")[1];
					var min = loadedSlots[i].startTime.split(":")[1];
					var timeSlot = hour + ":" + min;
					<!-- check this conversion is right -->
					var durationInMinutes = loadedSlots[i].duration/60000;
					var student = loadedSlots[i].bookedUser;
					var comment = loadedSlots[i].comment;
					var hidden = false;
					if(student === undefined || student===null) {
						student = "";
						comment = "Empty Slot";
						hidden = true;
					}
					<!-- sort out leading zero -->
					var endMin = parseInt(min) + parseInt(durationInMinutes);
					var endHour = parseInt(hour);
					while (endMin >= 60) {
						endMin = endMin%60;
						endHour++;
					}
					var leadingZero = "";
					if (endMin < 10) {
						leadingZero = "0";
					}
					var timeStamp = hour + ":" + min + " - " + endHour + ":" + leadingZero + endMin;
					this.slots.push({_id: loadedSlots[i]._id , duration: durationInMinutes , student: student, comment: comment,
									 time : timeSlot, timeStamp: timeStamp, hidden : hidden});
				}
				this.date = loadedSlots[0].startTime.split(":")[0].split("T")[0];
			},
			alertError: function() {
				alert("Sorry, something went wrong accessing signups data");
			},
			tickerChange: function(event) {
				if(event.target.checked) {
					this.ticker = event.target.label;
					this.pathLoadSlots = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/sheets/" + this.sessionId + "/tickers/" + this.ticker;
					this.$.ajaxLoadSlots.go();
				}
			},
			getReport : function(event) {
				var slotId = event.target.id;
				for(i=0;i<this.slots.length;i++) {
					if(this.slots[i]._id === slotId) {
						this.crsId = this.slots[i].student;
						this.tickId = this.slots[i].comment;
						this.repoName = this.crsId + "/" + this.tickId.replace(",","/");
						break;
					}
				}
			}
		})
  </script>
</polymer-element>
