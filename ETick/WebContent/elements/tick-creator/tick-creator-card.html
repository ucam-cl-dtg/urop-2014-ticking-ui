<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog-transition.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="static-list.html">
<link rel="import" href="static-list-labels.html">
<link rel="import" href="../date-entry.html">

<polymer-element name="tick-creator-card" attributes="tickId">
<template>
    <style>
        .checkboxContainer {
            padding: 20px 20px 20px 0;
            margin: 0;
        }
        h4 {
            padding: 0;
            margin-bottom: -10px;
        }
        #mainContainer {
            margin-top: 0;
            padding: 0 20px;
        }
        paper-checkbox::shadow #ink {
            top: -16px;
            left: -16px;
            width: 50px;
            height: 50px;
        }
        paper-checkbox {
            /* Firefox/IE compatibility */
            width: 15px;
            height: 15px;
        }
        paper-button {
            margin: 20px;
            width: 10em;
            height: 35px; /* Firefox/IE compatibility */
        }
        paper-button.colored {
            background: #259b24;
            color: #fff;
        }
        paper-toggle-button {
            margin-top: 23px;
            margin-left: 8px;
        }
        #cmdRestoreDefaults {
            width: 165px;
            margin: 0;
            font-size: 15px;
        }

        /* Styles for add member dialog. */
        paper-dialog .subtitle {
            font-weight: 200;
            font-size: 1.2rem;
        }
        polyfill-next-selector {shadow: "paper-dialog h1"}
        paper-dialog::shadow h1 {
            margin-bottom: 10px;
        }
        #dialogCancel {
            margin: 5px;
            background: #4285f4;
            color: #fff;
        }
        #dialogSubmit {
            margin: 5px;
            background: #4285f4;
            color: #fff;
        }
    </style>

    <!-- Get groups for this author -->
    <core-ajax
        id="ajaxLoadGroups"
        url="{{pathLoadGroups}}"
        handleAs="json"
        on-core-response="{{groupsDataLoaded}}"
        on-core-error="{{showErrorToast}}">
    </core-ajax>

    <!-- get and update all other existing tick data -->
    <core-ajax
            id="ajaxLoadTickData"
            url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/tick/' + tickId + '/'}}"
            handleAs="json"
            on-core-response="{{tickDataLoaded}}"
            on-core-error="{{showLoadErrorToast}}">
    </core-ajax>
    <!---->
    <core-ajax
            id="ajaxPutTickData"
            handleAs="json"
            contentType="application/json"
            method="PUT"
            on-core-error="{{showSaveErrorToast}}"
            on-core-response="{{tickDataUpdated}}">
    </core-ajax>
    <core-ajax
            id="ajaxPostTickData"
            handleAs="json"
            contentType="application/json"
            url="{{pathPutTickData}}"
            method="POST"
            on-core-error="{{showSaveErrorToast}}"
            on-core-response="{{tickDataSaved}}">
    </core-ajax>

    <!-- get and update stylistic data -->
    <core-ajax
            id="ajaxLoadDefaults"
            url="http://urop2014.dtg.cl.cam.ac.uk/UROP-TestingSystem/rest/testerAPI/v2/testFiles"
            handleAs="json"
            on-core-response="{{defaultsLoaded}}"
            on-core-error="{{showLoadErrorToast}}">
    </core-ajax>
    <core-ajax
            id="ajaxSaveLoadDefaults"
            url="http://urop2014.dtg.cl.cam.ac.uk/UROP-TestingSystem/rest/testerAPI/v2/testFiles"
            handleAs="json"
            auto
            on-core-response="{{savingDefaultsLoaded}}"
            on-core-error="{{showLoadErrorToast}}">
    </core-ajax>
    <core-ajax
            id="ajaxLoadStatic"
            url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP-TestingSystem/rest/testerAPI/v2/' + tickId + '/testFiles'}}"
            handleAs="json"
            on-core-response="{{staticDataLoaded}}"
            on-core-error="{{showLoadErrorToast}}">
    </core-ajax>
    <core-ajax
            id="ajaxSendStatic"
            url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP-TestingSystem/rest/testerAPI/v2/' + tickId + '/create'}}"
            handleAs="json"
            contentType="application/json"
            method="POST"
            on-core-response="{{saveTickData}}"
            on-core-error="{{showSaveErrorToast}}">
    </core-ajax>



    <div id="mainContainer">
        <h4>DISPLAY NAME</h4>
        <br>
        <div layout horizontal>
            <div id="divDisplayName" flex>
                <div>{{tickName}}</div>
                <br>
            </div>
            <paper-input hidden?="{{inputDisplayNameHidden}}" id="inputDisplayName" flex label="e.g. 1A-Java-Tick-1"
                         inputValue="{{tickName}}" required error="Required; can't have spaces" validate="^[0-9a-zA-Z][0-9a-zA-Z_-]*$"
                         on-keyup="{{validateDisplayName}}">
            </paper-input>
        </div>

        <core-collapse id="collapseCodeTemplate" opened="false">
            <h4>TEMPLATE REPOSITORY</h4>
            <br>
            <div layout horizontal>
                <div id="codeTemplateAddress" flex>http://stuff</div>
            </div>
            <br>
        </core-collapse>

        <div layout horizontal>
            <h4>MASTER DEADLINE</h4>
            <paper-toggle-button id="deadlineSwitch" on-change="{{toggleDeadline}}"></paper-toggle-button>
        </div>
        <core-collapse id="collapseDeadline" opened="{{dateShown}}">
            <date-entry valid="{{dateValid}}" day="{{day}}" month="{{month}}" year="{{year}}"></date-entry>
        </core-collapse>

        <br>

        <div layout horizontal>
            <h4 style="height: 19px;">ADD TO GROUPS</h4>
            <paper-toggle-button id="groupsSwitch" on-change="{{toggleGroups}}"></paper-toggle-button>
        </div>
        <core-collapse id="collapseGroups">
            <div layout horizontal wrap style="padding-left: 20px; padding-bottom: 20px;">
            <template repeat="{{group in groups}}">
                    <span layout horizontal style="margin-top: 20px;">
                        <paper-checkbox checked="{{group.selected}}"></paper-checkbox>
                        <span style="padding-left: 15px; margin-right: 20px; width: 250px;">{{group.text}}</span>
                    </span>
            </template>
            </div>

            <div hidden?="{{groups.length > 0}}">You don't have any groups!</div>
        </core-collapse>

        <br>

        <core-collapse id="collapseCorrectness" opened="false">
            <h4>CORRECTNESS CHECKS REPOSITORY</h4>
            <br>
            <div layout horizontal>
                <div id="correctnessAddress" flex>TODO</div>
            </div>
            <br>
        </core-collapse>



        <h4>STYLISTIC CHECKS</h4>
        <div class="checkboxContainer" layout horizontal>
            <paper-checkbox checked="{{checkJava}}" on-tap="{{toggleStylistic}}"></paper-checkbox>
            <span flex style="padding-left: 15px; margin: 0; min-height: 35px;">Analyse .java files</span>
            <paper-button
                    id="cmdRestoreDefaults"
                    label="RESTORE DEFAULTS"
                    raisedButton
                    end-justified
                    on-tap="{{cmdRestoreDefaults}}"
                    hidden?="{{!checkJava}}">
            </paper-button>
        </div>
        <core-collapse id="collapseStylistic" opened?="{{checkJava}}">
            <static-list-labels></static-list-labels>
            <static-list id="staticList" staticOptions="{{staticOptions}}"></static-list>
        </core-collapse>

        <!-- SAVE button -->
        <span layout horizontal>
            <span flex></span>
            <paper-button raisedButton class="colored" label="{{saving ? 'SAVING...' : 'SAVE'}}" on-tap="{{saveEverything}}"
                          disabled?="{{(dateShown && !dateValid) || (!inputDisplayNameHidden && !displayValid) || saving}}">
            </paper-button>
            <span flex></span>
        </span>
    </div>

    <paper-dialog id="alertRestoreDefaults" heading="Restore Defaults?" backdrop="true" transition="paper-transition-bottom">
        <p>This will clear your existing settings!</p>
        <paper-button id="dialogCancel" label="Cancel" dismissive autofocus></paper-button>
        <paper-button id="dialogSubmit" label="Continue" affirmative on-tap="{{restoreDefaults}}"></paper-button>
    </paper-dialog>

    <paper-toast id="toastLoadError" text="Error loading the tick."></paper-toast>
    <paper-toast id="toastSaveError" text="Error saving the tick."></paper-toast>
    <paper-toast id="toastSaved" text="Tick saved."></paper-toast>
    <paper-toast id="toastUpdated" text="Tick updated."></paper-toast>
</template>
<script>
    Polymer('tick-creator-card', {
        ready: function() {
            console.log("1: ready");
            this.styleLabel = "";

            this.pathLoadGroups = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/user/AUTHOR/";
           // this.pathLoadTickData = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/tick/tester/";
            this.pathPutTickData = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/tick";
            //"http://localhost:8000/testTickData.json";

            this.checkJava = false; //for those using a confused IDE: useDefaults IS being used, for Polymer data binding awesomeness
            this.groups = [];
            this.saving = false;
            this.newTick = null;
            this.tickData = {};
            this.staticOptions = [];

            if (this.tickId == null || this.tickId == "") {
                this.newTick = true;
                this.$.ajaxLoadDefaults.go();
            } else {
                this.newTick = false;
                this.checkJava = false;
                console.log("2: loading tick data");
                this.$.ajaxLoadTickData.go();
                this.$.ajaxLoadStatic.go();
            }
        },
        staticDataLoaded: function() {
            this.staticOptions = this.$.ajaxLoadStatic.response.slice(0);

            if (this.staticOptions.length == 0) {
                this.$.ajaxLoadDefaults.go();
            } else {
                this.checkJava = true;
                for (var i = 0; i < this.staticOptions.length; i++) {
                    this.staticOptions[i].closed = false;
                }
            }
        },
        defaultsLoaded: function() {
            this.staticOptions = this.$.ajaxLoadDefaults.response.slice(0);

            for (var i = 0; i < this.staticOptions.length; i++) {
                this.staticOptions[i].closed = false;
            }
        },
        savingDefaultsLoaded: function() {
            this.defaults = this.$.ajaxSaveLoadDefaults.response.slice(0);
            //this.saveStaticOpts();
        },

        /**
         * Load group data and figure out which groups have been selected
         * Assert tickDataLoaded has already run.
         */
        groupsDataLoaded: function() {
            var loadedGroups = this.$.ajaxLoadGroups.response.slice(0);
            this.groups = [];

            for (var i = 0; i < loadedGroups.length; i++) {
                this.groups[this.groups.length] = {_id: loadedGroups[i]._id, selected: false, text: loadedGroups[i].name};
            }

            for (var g = 0; g < this.tickData.groups.length; g++) {
                for (var k = 0; k < this.groups.length; k++) {
                    if (this.tickData.groups[g] == this.groups[k]._id) {
                        this.groups[k].selected = true;
                    }
                }
            }
        },
        tickDataLoaded: function() {
            console.log("3: loaded tick data");
            this.tickData = this.$.ajaxLoadTickData.response;
            if (!this.newTick){
                this.tickId = this.tickData._id;
            }

            console.log("4: tick data is:");
            console.log(this.tickData);

            this.processLoadedTickData();
        },
        tickDataSaved: function() {
            /* when a user clicks save, they shouldn't be able to click again until the update is complete, so the SAVE
             button is disabled while saving. However, if the SAVE operation is really fast, this creates a jarring UX,
             so this artificial day smooths the UX */
            this.job('complete-saving', function() {
                this.saving = false;
                this.$.toastUpdated.show();
            }, 500);

            this.newTick = false;
            this.tickData = this.$.ajaxPostTickData.response;

            this.tickId = this.tickData._id;
            this.processLoadedTickData();

            this.$.toastSaved.show();
        },
        tickDataUpdated: function() {
            /* when a user clicks save, they shouldn't be able to click again until the update is complete, so the SAVE
            button is disabled while saving. However, if the SAVE operation is really fast, this creates a jarring UX,
            so this artificial day smooths the UX */
            this.job('complete-saving', function() {
                this.saving = false;
                this.$.toastUpdated.show();
            }, 500);

            this.newTick = false;
            this.tickData = this.$.ajaxPutTickData.response;
            this.processLoadedTickData();
        },
        /**
         * Once the ajax get request is complete, bind the fields on this card to the received data
         */
        processLoadedTickData: function() {
            console.log("5: processing loaded tick data");

            //Set up display name
            if (this.newTick) {
                console.log("6: set display name");
                //if the tick name is blank, then a new tick is being created, so show the tick naming input
                this.$.divDisplayName.hidden = true;
                this.inputDisplayNameHidden = false;
            } else {
                console.log("6: ERR: didn't set display name");
                //Otherwise, the tick already exists so show the read only field
                this.$.divDisplayName.hidden = false;
                this.inputDisplayNameHidden = true;
                this.tickName = this.tickData.name;
            }

            console.log("7: script ok");

            if (!this.newTick) {
                this.$.collapseCodeTemplate.opened = true;
                this.$.codeTemplateAddress.innerHTML = this.tickData.stubRepo;
            }

            //if the tick is not being created and it currently has a deadline, show it
            if (!this.newTick) {
                if (this.tickData.deadline != null) {
                    //By checking the deadline switch, the deadline entry fields will be shown
                    this.$.deadlineSwitch.checked = true;

                    var deadline  = new Date(this.tickData.deadline);

                    var day = deadline.getUTCDate().toString();
                    var month = (deadline.getUTCMonth() + 1).toString();
                    var year = (deadline.getUTCFullYear()).toString();

                    //pad day and month to include leading zero if necessary
                    if (day.length == 1) {day = "0" + day}
                    if (month.length == 1) {month = "0" + month}

                    this.day = day;
                    this.month = month;
                    this.year = year;
                }
            }

            //Init groups
            if (!this.newTick) {
                if (this.tickData.groups.length > 0) {
                    this.$.groupsSwitch.checked = true;
                }
            }

           //correctness tests
            if (!this.newTick) {
                this.$.collapseCorrectness.opened = true;
                this.$.correctnessAddress.innerHTML = this.tickData.correctnessRepo;
            }

            //load groups which user is an author for
            this.$.ajaxLoadGroups.go();
        },
        toggleStylistic: function() {
            //this.$.collapseStylistic.toggle();
        },
        toggleCodeTemplate: function() {
            this.$.collapseCodeTemplate.opened = this.$.codeTemplateSwitch.checked;
        },
        toggleDeadline: function() {
            this.$.collapseDeadline.opened = this.$.deadlineSwitch.checked;
        },
        toggleGroups: function() {
            this.$.collapseGroups.opened = this.$.groupsSwitch.checked;
        },
        validateDisplayName: function() {
            this.displayValid = !((this.$.inputDisplayName.inputValue.trim() == "") || this.$.inputDisplayName.invalid);
        },
        saveEverything: function() {
            this.saving = true;

            var tickData = this.buildTickData();
            var staticData = this.buildStaticData();

            console.log("built everything");

            var masterObject = {
                name: tickData.name,
                deadline: tickData.deadline,
                groups: tickData.groups,
                checkstyleOpts: staticData
            };

            console.log("master object: ");
            console.log(masterObject);

            if (!this.newTick) {
                console.log("not a new tick");
                this.$.ajaxPutTickData.body = JSON.stringify(masterObject);
                this.$.ajaxPutTickData.url = "http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/tick/" + this.tickId;
                this.$.ajaxPutTickData.go();
            } else {
                console.log("new tick");
                this.$.ajaxPostTickData.body = JSON.stringify(masterObject);
                this.$.ajaxPostTickData.go();
            }
            console.log("sent");
        },
        buildTickData: function() {
            //Set name if a new tick
            this.tickData = {name: null,  deadline: null,  groups: null};

            if (this.newTick) {
                this.tickData.name = this.$.inputDisplayName.inputValue.trim();
            }
            console.log("name set");
            //Don't set template repository (this is generated by back end)

            //Update master deadline
            if (this.$.deadlineSwitch.checked) {
                var year = this.year;
                var month = this.month - 1;
                var day = this.day;
                var date = new Date();
                date.setUTCDate(day);
                date.setUTCMonth(month);
                date.setUTCFullYear(year);
                this.tickData.deadline = date.toISOString();
            } else {
                this.tickData.deadline = null;
            }
            console.log("deadline set");
            //update groups
            this.tickData.groups = [];
            if (this.$.groupsSwitch.checked) {
                for (var i = 0; i < this.groups.length; i++) {
                    if (this.groups[i].selected) {
                        this.tickData.groups[this.tickData.groups.length] = this.groups[i]._id;
                    }
                }
            }

            return this.tickData;
        },
        buildStaticData: function() {
            var sendData = [];

            if (!this.checkJava) {
                return sendData;
            }

            for (var i = 0; i < this.$.staticList.staticOptions.length; i++) {
                if (!(this.$.staticList.staticOptions[i].closed)) {
                    sendData[sendData.length] = {
                        text: this.$.staticList.staticOptions[i].text,
                        checkedIndex: this.$.staticList.staticOptions[i].checkedIndex,
                        code: this.$.staticList.staticOptions[i].code};
                }
            }

            return sendData;
        },
        cmdRestoreDefaults: function() {
            this.$.alertRestoreDefaults.toggle();
        },
        restoreDefaults: function() {
            this.$.ajaxLoadDefaults.go();
        },
        showLoadErrorToast: function(e, detail) {
            console.log("ERR: couldn't load");
            if (detail.xhr.responseText != null) {
                this.$.toastLoadError.text = detail.xhr.responseText;
            } else {
                this.$.toastLoadError.text = "Error loading tick.";
            }
            this.$.toastLoadError.show();
        },
        showSaveErrorToast: function(e, detail) {
            this.saving = false;

            if (detail.xhr.responseText != null) {
                this.$.toastSaveError.text = detail.xhr.responseText;
            } else {
                this.$.toastSaveError.text = "Error saving tick.";
            }
            this.$.toastSaveError.show();
        }
    });
</script>
</polymer-element>