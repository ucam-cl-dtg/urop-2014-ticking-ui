<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="toast-ajax/toast-ajax.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="user-card.html">
<link rel="import" href="ssh-card.html">
<link rel="import" href="main-card.html">
<link rel="import" href="upcoming-slots.html">
<link rel="import" href="loading-spinner.html">

<polymer-element name="user-dash" attributes="data">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>

		<core-overlay id="loadingOverlay" backdrop autoCloseDisabled>
			<loading-spinner></loading-spinner>
		</core-overlay>

		<!-- Upcoming events API call. -->
		<toast-ajax id="upcomingAPI"
			auto
			url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/signups/bookings"
			handleAs="json"
			on-core-response="{{upcomingResponse}}"
			
			popUpError
			captureError
			waitMessage="Loading your upcoming signups....">
		</toast-ajax>

		<template if="{{data && !data.ssh}}">
			<main-card animated>
				<ssh-card id="userCard"></ssh-card>
			</main-card>
		</template>
		
		<template if="{{data}}">
			<main-card animated>
				<user-card id="userCard" ldap="{{data}}"></user-card>
			</main-card>
		</template>

		<template if="{{slots}}">
			<main-card animated>
				<upcoming-slots slots="{{slots}}"></upcoming-slots>
			</main-card>
		</template>
		
	</template>

	<script>
		Polymer('user-dash', {
			ready: function () {
				if (!this.data) {
					this.$.loadingOverlay.open();
				}
			},

			dataChanged: function (oldValue, newValue) {
				if (newValue && this.$.loadingOverlay.opened) {
					this.async(function () {
						this.$.loadingOverlay.close();
					}, null, 1000);
				}
			},

			upcomingResponse: function() {
				this.slots = this.$.upcomingAPI.response;
			}
		});
	</script>
</polymer-element>
