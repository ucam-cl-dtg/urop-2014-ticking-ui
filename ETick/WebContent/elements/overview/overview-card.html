<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="overview-list.html">
<link rel="import" href="overview-ticks-bar.html">
<link rel="import" href="overview-users-bar.html">

<polymer-element name="overview-card">
    <template>
        <link rel="stylesheet" href="overview.css">

        <style>
            #template:nth-child(odd){
                background: #f6f6f6;
            }
            #template:nth-child(even) {
                background: #e9e9e9;
            }
        </style>

        <core-ajax
                id="ajaxLoadOverview"
                auto
                url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/53ea39f9e4b00e79c9984081/status/csv"
                handleAs="text"

                on-core-response="{{overviewLoaded}}">
        </core-ajax>

        <!-- Card content goes here -->

        <div style="height: 600px;" layout vertical style="position: relative">
            <div layout horizontal style="min-height: 150px; background: #2D91EC; color: #ABD3F7">
                <!-- fixed bit -->
                <template repeat="{{item in ['Name', 'Forename(s)', 'College']}}" layout horizontal>
                    <div layout horizontal end class="user-label">
                        <div on-tap="{{sort}}" class="user-label unselectable">{{item}}</div>
                    </div>
                </template>

                <div id="vShadowHeader" style="height: 143px;"></div>

                <!-- Top bar -->
                <div style="overflow-x: hidden; height: 150px;" layout horizontal>
                    <div id="headings" style="overflow: hidden; height: 150px; margin-left: -6px;">
                        <overview-ticks-bar style="height: 150px;" tickNames="{{tickNames}}"></overview-ticks-bar>
                    </div>
                </div>


            </div>
            <div id="hShadow"></div>

            <div layout horizontal style="margin-top: -6px">
                <!-- user names and colleges -->
                <div layout vertical>
                    <div id="userHeadings" style="overflow: hidden;">
                        <overview-users-bar sortField="{{sortField}}" users="{{users}}"></overview-users-bar>
                        <div style="height: 100px;"></div>
                    </div>

                    <!-- horizontal scroll bar spacer -->
                    <!--<div style="height: 20px;"></div>-->
                </div>

                <div id="vShadow"></div>

                <!-- Scrolling content -->
                <div id="scrollArea" style=" overflow-x: scroll; margin-left: -6px;" on-scroll="{{scrolled}}" flex>
                    <template repeat="{{user in users}}">
                        <div id="template">
                            <overview-list user="{{user}}"></overview-list>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer('overview-card', {
            created: function() {
                this.buildCollegeDictionary();
            },

            overviewLoaded: function() {
                //load string of comma separated values
                var csv = this.$.ajaxLoadOverview.response;

                //split into rows
                var split = csv.split("\n");

                //split each row into columns
                var arrayed = split.map(function(el) {
                    return el.split(',');
                });

                console.log(this.collegeDict);

                //build user objects from these columns
                var that = this;
                var users = arrayed.map(function(el) {
                   return {
                       foreNames: el[0].split(" ").slice(0, el[0].split(" ").length - 1).join(" "),
                       lastName: el[0].split(" ").slice(el[0].split(" ").length - 1),
                       crsId: el[1],
                       college: el[2],
                       collegeAbbr: that.collegeDict.hasOwnProperty(el[2]) ? that.collegeDict[el[2]] : "",
                       displayStrings:
                               el.splice(4, el.length - 1).map(function (el) {
                                   var iconCode;
                                   var tooltip;

                                   if (el == "Unit failed") {
                                       iconCode = "F";
                                       tooltip = "Failed automated tests.";
                                   } else if (el == "Unit passed") {
                                       iconCode = "U";
                                       tooltip = "Passed automated tests.";
                                   } else if (el == "Initilialised") {
                                       iconCode = "I";
                                       tooltip = "Not submitted.";
                                   } else if (el.lastIndexOf("PASSED by") > -1) {
                                       iconCode = "P";
                                       el = el.toLowerCase();
                                       tooltip = el.charAt(0).toUpperCase() + el.slice(1);
                                   } else if (el == "") {
                                       iconCode = "-";
                                       tooltip = "Not started.";
                                   } else {
                                       iconCode = el;
                                   }



                                   return {iconCode: iconCode, tooltip: tooltip};
                               })
                   }
                });

                //build list of column titles
                var colTitles = users[0].displayStrings.map(function(el) {
                    return el.iconCode;
                });

                //remove the first two rows (column headings and a blank line)
                users = users.slice(2, users.length - 1 );

                //users = users.concat(users);
                //users = users.concat(users);

               /* users = users.map(function(el) {
                   if (el.college == "Girton") {
                       el.college = "Gonville and Cauis"
                   }
                    return el;
                });*/


                //use the list of column titles to convert each user's tickComments into a dictionary
                console.log(users);
                console.log(colTitles);

                this.users = users;
                this.tickNames = colTitles;

                this.sortLastNameAscending();
            },

            sort: function(a, b, sender) {
                if (this.sortField == sender.innerHTML) {
                    this.sortDir *= -1;
                } else {
                    this.sortField = sender.innerHTML;
                    this.sortDir = 1;
                }

                switch (this.sortField) {
                    case "Name":
                        this.sortLastName(this.sortDir);
                        break;
                    case "Forename(s)":
                        this.sortForeNames(this.sortDir);
                        break;
                    case "College":
                        this.sortCollege(this.sortDir);
                        break;
                }

            },

            sortLastNameAscending: function() {
                this.sortField = "Name";
                this.sortDir = "1";
                this.sortLastName(1);
            },

            /**
             * This should only be called by sortLastNameAscending and sortLastNameDescending, to ensure correct usage
             * of the mode parameter
             */
            sortLastName: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.lastName < b.lastName) {
                        return -1 * mode;
                    } else if (a.lastName > b.lastName) {
                        return mode;
                    } else {
                        if (a.foreNames < b.foreNames) {
                            return -1 * mode;
                        } else if (a.foreNames > b.foreNames) {
                            return mode;
                        } else {
                            if (a.college < b.college) {
                                return -1 * mode;
                            } else if (a.college > b.college) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            sortForeNames: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.foreNames < b.foreNames) {
                        return -1 * mode;
                    } else if (a.foreNames > b.foreNames) {
                        return mode;
                    } else {
                        if (a.lastName < b.lastName) {
                            return -1 * mode;
                        } else if (a.lastName > b.lastName) {
                            return mode;
                        } else {
                            if (a.college < b.college) {
                                return -1 * mode;
                            } else if (a.college > b.college) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            sortCollege: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.college < b.college) {
                        return -1 * mode;
                    } else if (a.college > b.college) {
                        return mode;
                    } else {
                        if (a.lastName < b.lastName) {
                            return -1 * mode;
                        } else if (a.lastName > b.lastName) {
                            return mode;
                        } else {
                            if (a.foreNames < b.foreNames) {
                                return -1 * mode;
                            } else if (a.foreNames > b.foreNames) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            buildCollegeDictionary: function() {
                var college = {};

                college["Christ's"]           = "CHRISTS";
                college["Churchill"]          = "CHURCH";
                college["Clare"]              = "CLARE";
                college["Corpus Christi"]     = "CORPUS";
                //Darwin
                college["Downing"]            = "DOWN";
                college["Emmanuel"]           = "EMM";
                college["Fitzwilliam"]        = "FITZ";
                college["Girton"]             = "GIRTON";
                college["Gonville and Caius"] = "CAIUS";
                college["Homerton"]           = "HOM";
                college["Jesus"]              = "JESUS";
                college["King's"]             = "KINGS";
                college["Lucy Cavendish"]     = "";
                college["Magdalene"]          = "MAGD";
                college["Murray Edwards"]     = "";
                college["Newnham"]            = "NEWH";
                college["Pembroke"]           = "PEMB";
                college["Peterhouse"]         = "PET";
                college["Queens'"]            = "QUEENS";
                college["Robinson"]           = "ROBIN";
                college["Selwyn"]             = "SEL";
                college["Sidney Sussex"]      = "SID";
                college["St Catharine's"]     = "CATH";
                college["St Edmund's"]        = "EDMUND";
                college["St John's"]          = "JOHNS";
                college["Trinity"]            = "";
                //Westminster
                //Wolfson

                this.collegeDict = college;
            },

            scrolled: function() {
                this.$.headings.scrollLeft = this.$.scrollArea.scrollLeft;
                this.$.userHeadings.scrollTop = this.$.scrollArea.scrollTop;

                if (this.$.scrollArea.scrollTop > 0) {
                    this.$.hShadow.classList.add('horizontalDropShadow');
                } else {
                    this.$.hShadow.classList.remove('horizontalDropShadow');
                }

                if (this.$.scrollArea.scrollLeft > 0) {
                    this.$.vShadow.classList.add('verticalDropShadow');
                    this.$.vShadowHeader.classList.add('verticalDropShadow');
                } else {
                    this.$.vShadow.classList.remove('verticalDropShadow');
                    this.$.vShadowHeader.classList.remove('verticalDropShadow');
                }

                this.$.userHeadings.width = this.$.scrollArea.clientWidth;
            }
        });
    </script>
</polymer-element>