<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="overview-item.html">
<link rel="import" href="overview-ticks-bar.html">
<link rel="import" href="overview-users-bar.html">

<polymer-element name="overview-card">
    <template>
        <link rel="stylesheet" href="overview.css">

        <style>
            #template:nth-child(odd){
                background: #f6f6f6;
            }
            #template:nth-child(even) {
                background: #e9e9e9;
            }
        </style>

        <core-ajax
                id="ajaxLoadOverview"
                auto
                url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/53ea39f9e4b00e79c9984081/status/csv"
                handleAs="text"

                on-core-response="{{overviewLoaded}}">
        </core-ajax>

        <!-- Card content goes here -->

        <div style="height: 600px;" layout vertical>
            <div layout horizontal style="min-height: 150px;">
                <!-- fixed bit -->
                <template repeat="{{item in ['Name', 'Forename(s)', 'College']}}" layout horizontal>
                    <div layout horizontal end class="user-label">
                    <h4 class="user-label">{{item}}</h4>
                    </div>
                </template>

                <!-- Top bar -->
                <div style="overflow-x: hidden; height: 150px;" layout horizontal>
                    <div id="headings" style="overflow: hidden; height: 150px;">
                        <overview-ticks-bar style="height: 150px;" tickNames="{{tickNames}}"></overview-ticks-bar>
                    </div>
                </div>

                <!-- vertical scroll bar spacer -->
            </div>

            <div layout horizontal>
                <!-- user names and colleges -->
                <div layout vertical>
                    <div id="userHeadings" style="overflow: hidden;">
                        <overview-users-bar users="{{users}}"></overview-users-bar>
                    </div>

                    <!-- horizontal scroll bar spacer -->
                    <!--<div style="height: 20px;"></div>-->
                </div>

                <!-- Scrolling content -->
                <div id="scrollArea" style=" overflow-x: scroll;" on-scroll="{{scrolled}}" flex>
                    <template repeat="{{user in users}}">
                        <div id="template">
                        <overview-item user="{{user}}"></overview-item>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer('overview-card',{
            overviewLoaded: function() {
                //load string of comma separated values
                var csv = this.$.ajaxLoadOverview.response;

                //split into rows
                var split = csv.split("\n");

                //split each row into columns
                var arrayed = split.map(function(el) {
                    return el.split(',');
                });

                //build user objects from these columns
                var users = arrayed.map(function(el) {
                   return {
                       foreNames: el[0].split(" ").slice(0, el[0].split(" ").length - 1).join(" "),
                       lastName: el[0].split(" ").slice(el[0].split(" ").length - 1),
                       crsId: el[1],
                       college: el[2],
                       tickComments: el.splice(4, el.length - 1).map(function(el) {
                           if (el == "Unit failed") {
                               return "F";
                           } else if (el == "Unit passed") {
                               return "U"
                           } else if (el == "Initilialised") {
                               return "I"
                           } else if (el.lastIndexOf("PASSED by") > -1) {
                                return "P"
                           } else if (el == "") {
                                return "-"
                           }    else{
                               return el;
                           }
                       })
                   }
                });

                //build list of column titles
                var colTitles = users[0].tickComments;

                //remove the first two rows (column headings and a blank line)
                users = users.slice(2, users.length - 1 );

                users = users.concat(users);
                users = users.concat(users);
                users = users.concat(users);
                users = users.concat(users);

               /* users = users.map(function(el) {
                   if (el.college == "Girton") {
                       el.college = "Gonville and Cauis"
                   }
                    return el;
                });*/

                //use the list of column titles to convert each user's tickComments into a dictionary
                console.log(users);
                console.log(colTitles);

                this.users = users;
                this.tickNames = colTitles;
            },

            scrolled: function() {
                this.$.headings.scrollLeft = this.$.scrollArea.scrollLeft;
                this.$.userHeadings.scrollTop = this.$.scrollArea.scrollTop;

                this.$.userHeadings.width = this.$.scrollArea.clientWidth;
            }
        });
    </script>
</polymer-element>