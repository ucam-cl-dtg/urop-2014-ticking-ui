<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../search-box.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<link rel="import" href="../export-status.html">
<link rel="import" href="overview-list.html">
<link rel="import" href="overview-ticks-bar.html">
<link rel="import" href="overview-users-bar.html">

<polymer-element name="overview-card" attributes="gid">
    <template>
        <link rel="stylesheet" href="overview.css">
        <link rel="stylesheet" href="../../css/shared-styles.css">

        <toast-ajax
                id="ajaxLoadOverview"
                auto
                url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/' + gid + '/status/csv'}}"
                handleAs="text"
                on-core-response="{{overviewLoaded}}"

                waitBeforeToast="500"
                waitMessage="Loading Overview..."
                popUpError
                captureError
                errorMessage="Error loading overview.">
        </toast-ajax>

        <div style="max-height: 600px; position: relative;" layout vertical>
            <div layout horizontal style="background: #2D91EC; color: #ABD3F7" class="overview-header-height">
                <!-- Top left fixed area -->
                <div layout vertical style="min-width: 435px;">
                    <div flex></div>

                    <!-- Search Box -->
                    <div id="headerBar" layout horizontal center style="height: 46px;">
                        <span flex></span>
                        <search-box id="overviewSearchBox" placeholder="Search..." query="{{query}}"></search-box>
                    </div>

                    <!-- User details column headers -->
                    <div layout horizontal>
                    <template repeat="{{item in ['Name', 'Forename(s)', 'College']}}" layout horizontal>
                        <div layout horizontal end class="user-label">
                            <div on-tap="{{sort}}" class="{{'user-label unselectable' + (sortField == item ? ' sort-field-header' : '')}}">{{item}}</div>
                        </div>
                    </template>
                    </div>
                </div>

                <!-- Vertical shadow in the header -->
                <div id="vShadowHeader" style="height: 144px; z-index: 200000"></div>

                <!-- Tick headings -->
                <div flex style="overflow-x: hidden; margin-left: -6px;" layout horizontal class="overview-header-height">
                    <div id="headings" style="overflow: hidden; margin-left: -6px;" class="overview-header-height">
                        <overview-ticks-bar id="overviewTicksBar" style="height: 150px;" tickNames="{{tickNames}}"
                                            on-tick-selected="{{sortTick}}"
                        ></overview-ticks-bar>
                    </div>
                </div>

                <!-- Refresh and export buttons -->
                <div end style="height: 50px; position: absolute; top: -5px; right: 0;" layout horizontal>
                    <core-tooltip class="delete-tooltip" label="Refresh">
                        <paper-icon-button icon="refresh" on-tap="{{refresh}}"></paper-icon-button>
                    </core-tooltip>
                    <core-tooltip class="delete-tooltip" label="Export">
                        <export-status gid="{{gid}}"></export-status>
                    </core-tooltip>
                </div>
            </div>

            <div id="hShadow"></div>

            <!-- Compents below blue bar -->
            <div layout horizontal style="margin-top: -6px">
                <!-- user names and colleges -->
                <div layout vertical>
                    <div id="userHeadings" style="overflow: hidden;">
                        <overview-users-bar sortField="{{sortField}}" users="{{displayUsers}}"></overview-users-bar>
                        <div style="height: 30px;"></div>
                    </div>
                </div>

                <div id="vShadow"></div>

                <!-- Scrolling content -->
                <div id="scrollArea" style="overflow-x: auto; margin-left: -6px;" on-scroll="{{scrolled}}" flex>
                   <template repeat="{{user in displayUsers}}">
                        <div id="template">
                            <overview-list user="{{user}}" scrollAreaLeft="{{scrollAreaLeft}}"
                                           scrollAreaWidth="{{scrollAreaWidth}}">
                            </overview-list>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer('overview-card', {
            created: function() {
                this.scrollAreaLeft = 0;    //used by overview list to determine if the tooltips should be pointing left
                                            //or right in order to not be cut off screen

                this.iconCodeDict = {};
                this.iconCodeDict["PASSED"] = "P";
                this.iconCodeDict["FAILED"] = "F"; //TODO
                this.iconCodeDict["UP"]     = "UP";
                this.iconCodeDict["UF"]     = "UF";
                this.iconCodeDict["I"]      = "I";
                this.iconCodeDict[""]       = "-";
            },

            overviewLoaded: function() {
                //load string of comma separated values
                var csv = this.$.ajaxLoadOverview.response;

                //split into rows
                var split = csv.split("\n");

                //split each row into columns
                //assert that tick names do not contain commas (otherwise everything will be screwed up)
                var arrayed = split.map(function(el) {
                    return el.split(',');
                });

                //build user objects from these columns
                var that = this;
                var iconCodeDict = this.iconCodeDict;
                var users = arrayed.map(function(el) {
                   return {
                       foreNames: el[0].split(" ").slice(0, el[0].split(" ").length - 1).join(" "),
                       lastName: el[0].split(" ").slice(el[0].split(" ").length - 1),
                       crsId: el[1],
                       college: el[2],
                       displayStrings:
                               el.splice(4, el.length - 1).map(function (el, index) {
                                   //display strings should be either blank or of the form "STATUSCODE (detail)"
                                   if (el == "") {
                                       return {iconCode: "-", tooltip: "Not started", index: index};
                                   }

                                   if (!(/^(.* \(.*\))$/.test(el))) {
                                       return {iconCode: el, tooltip: null, index: index};
                                   }

                                   var iconCode = el.split(" (")[0];
                                   var tooltip = el.split(" (")[1].replace(")", "");

                                   if (iconCodeDict.hasOwnProperty(iconCode)) {
                                       iconCode = iconCodeDict[iconCode];
                                   }

                                   return {iconCode: iconCode, tooltip: tooltip, index: index};
                               })
                   }
                });

                //build list of column titles. These are the display strings of the first user
                var colTitles = users[0].displayStrings.map(function(el) {
                    return el.iconCode;
                });

                for (var i = 0; i < colTitles.length; i++) {
                    colTitles[i] = {text: colTitles[i], index: i};
                }

                //remove the first two rows (column headings and a blank line) from users
                users = users.slice(2, users.length - 1 );

                this.users = users;
                this.displayUsers = users;
                this.tickNames = colTitles;

                this.sortLastNameAscending();
                this.updateScrollAreas();
            },


            sort: function(a, b, sender) {
                //Mark all tick headings as unselected
                this.$.overviewTicksBar.selectedIndex = -1;

                if (this.sortField == sender.innerHTML) {
                    this.sortDir *= -1;
                } else {
                    this.sortField = sender.innerHTML;
                    this.sortDir = 1;
                }

                switch (this.sortField) {
                    case "Name":
                        this.sortLastName(this.sortDir);
                        break;
                    case "Forename(s)":
                        this.sortForeNames(this.sortDir);
                        break;
                    case "College":
                        this.sortCollege(this.sortDir);
                        break;
                }
            },

            sortTick: function(e, params) {
                this.sortField = "";

                var comparisonDict = {};
                comparisonDict["-"] = 0;
                comparisonDict["I"] = 1;
                comparisonDict["F"] = 2;
                comparisonDict["U"] = 3;
                comparisonDict["P"] = 4;

                this.users.sort(function(a, b) {
                    return params.mode * (comparisonDict[a.displayStrings[params.selectedIndex].iconCode] -
                            comparisonDict[b.displayStrings[params.selectedIndex].iconCode]);
                });

                //TODO: should probably subsort by either last name or number of attempts made (when this becomes available)
            },

            sortLastNameAscending: function() {
                this.sortField = "Name";
                this.sortDir = "1";
                this.sortLastName(1);
            },

            queryChanged: function() {
                this.queryOrUsersChanged();
            },

            usersChanged: function() {
                this.queryOrUsersChanged();
            },

            queryOrUsersChanged: function() {
                var temp = this.overviewListFilter(this.users, this.query);

                this.displayUsers = [];
                for (var i = 0; i < temp.length; i++) {
                    this.displayUsers[i] = {
                        foreNames: temp[i].foreNames,
                        lastName: temp[i].lastName,
                        crsId: temp[i].crsId,
                        college: temp[i].college,
                        displayStrings: temp[i].displayStrings,
                        cssClass: i % 2 == 0 ? "overview-even" : "overview-odd"
                    }
                }
            },

            /**
             * This should only be called by sortLastNameAscending and sortLastNameDescending, to ensure correct usage
             * of the mode parameter
             */
            sortLastName: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.lastName < b.lastName) {
                        return -1 * mode;
                    } else if (a.lastName > b.lastName) {
                        return mode;
                    } else {
                        if (a.foreNames < b.foreNames) {
                            return -1 * mode;
                        } else if (a.foreNames > b.foreNames) {
                            return mode;
                        } else {
                            if (a.college < b.college) {
                                return -1 * mode;
                            } else if (a.college > b.college) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            sortForeNames: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.foreNames < b.foreNames) {
                        return -1 * mode;
                    } else if (a.foreNames > b.foreNames) {
                        return mode;
                    } else {
                        if (a.lastName < b.lastName) {
                            return -1 * mode;
                        } else if (a.lastName > b.lastName) {
                            return mode;
                        } else {
                            if (a.college < b.college) {
                                return -1 * mode;
                            } else if (a.college > b.college) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            sortCollege: function(mode) {
                this.users.sort(function(a, b) {
                    if (a.college < b.college) {
                        return -1 * mode;
                    } else if (a.college > b.college) {
                        return mode;
                    } else {
                        if (a.lastName < b.lastName) {
                            return -1 * mode;
                        } else if (a.lastName > b.lastName) {
                            return mode;
                        } else {
                            if (a.foreNames < b.foreNames) {
                                return -1 * mode;
                            } else if (a.foreNames > b.foreNames) {
                                return mode;
                            } else {
                                return 0;
                            }
                        }
                    }
                });
            },

            overviewListFilter: function(items, q) {
                if (items && q) {
                    return items.filter(this.overviewFilter.bind(this));
                }
                return items;
            },

            overviewFilter: function(item) {
                if (item == undefined || item == null || item == "") {
                    return false;
                }

                var qs = this.$.overviewSearchBox.query.toLowerCase().split(" ");
                return qs.filter(function(q) {
                    if (q == "") {
                        return false;
                    }

                    return (item.lastName[0].toLowerCase().indexOf(q) > -1 ||
                            item.foreNames.toLowerCase().indexOf(q) > -1 ||
                            item.college.toLowerCase().indexOf(q) > -1);
                }).length > 0;
            },

            scrolled: function() {
                //scroll the tick headers and user details with the tick status scroll area
                this.$.headings.scrollLeft = this.$.scrollArea.scrollLeft;
                this.$.userHeadings.scrollTop = this.$.scrollArea.scrollTop;

                //Apply shadows if necessary to give users a sense of place
                if (this.$.scrollArea.scrollTop > 0) {
                    this.$.hShadow.classList.add('horizontalDropShadow');
                } else {
                    this.$.hShadow.classList.remove('horizontalDropShadow');
                }

                if (this.$.scrollArea.scrollLeft > 0) {
                    this.$.vShadow.classList.add('verticalDropShadow');
                    this.$.vShadowHeader.classList.add('verticalDropShadow');
                } else {
                    this.$.vShadow.classList.remove('verticalDropShadow');
                    this.$.vShadowHeader.classList.remove('verticalDropShadow');
                }

                this.$.userHeadings.width = this.$.scrollArea.clientWidth;

                this.scrollAreaLeft = this.$.scrollArea.scrollLeft;
            },

            updateScrollAreas: function() {
                this.scrollAreaWidth = parseInt(getComputedStyle(this.$.scrollArea).getPropertyValue("width"));

                this.job('update-again', function() {
                    this.updateScrollAreas();
                }, 300);
            },

            refresh: function() {
                //This requires calling the same end point as loading, so I use the same toast-ajax, but in a different
                //context, which is why some attributes are changed
                this.$.ajaxLoadOverview.waitBeforeToast = "1";
                this.$.ajaxLoadOverview.waitMessage = "Refreshing overview...";
                this.$.ajaxLoadOverview.responseMessage = "Overview refreshed.";
                this.$.ajaxLoadOverview.popUpResponse = true;
                this.$.ajaxLoadOverview.go();
            }
        });
    </script>
</polymer-element>