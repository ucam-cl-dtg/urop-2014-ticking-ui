<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../toast-ajax/toast-ajax.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="overview-item.html">
<link rel="import" href="overview-headings.html">

<polymer-element name="overview-card">
    <template>
        <style>
            overview-item {
                width: 100%;
            }
        </style>

        <core-ajax
                id="ajaxLoadOverview"
                auto
                url="http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/group/53ea39f9e4b00e79c9984081/status/csv"
                handleAs="text"

                on-core-response="{{overviewLoaded}}">
        </core-ajax>

        <overview-headings tickNames="{{tickNames}}"></overview-headings>
        <template repeat="{{user in users}}">
            <overview-item user="{{user}}"></overview-item>
        </template>
    </template>
    <script>
        Polymer('overview-card',{
            overviewLoaded: function() {
                //load string of comma separated values
                var csv = this.$.ajaxLoadOverview.response;

                //split into rows
                var split = csv.split("\n");

                //split each row into columns
                var arrayed = split.map(function(el) {
                    return el.split(',');
                });

                //build user objects from these columns
                var users = arrayed.map(function(el) {
                   return {
                       foreNames: el[0].split(" ").slice(0, el[0].split(" ").length - 1).join(" "),
                       lastName: el[0].split(" ").slice(el[0].split(" ").length - 1),
                       crsId: el[1],
                       college: el[2],
                       tickComments: el.splice(4, el.length - 1)
                   }
                });

                //build list of column titles
                var colTitles = users[0].tickComments;

                //remove the first two rows (column headings and a blank line)
                users = users.slice(2, users.length - 1 );

                //use the list of column titles to convert each user's tickComments into a dictionary
                console.log(users);
                console.log(colTitles);

                this.users = users;
                this.tickNames = colTitles;
            }
        });
    </script>
</polymer-element>