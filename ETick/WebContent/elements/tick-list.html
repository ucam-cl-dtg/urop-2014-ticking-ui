<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="toast-ajax/toast-ajax.html">
<link rel="import" href="search-box.html">
<link rel="import" href="tick-box.html">
<link rel="import" href="box-list.html">
<link rel="import" href="add-tick.html">

<polymer-element name="tick-list" attributes="gid isAuthor canFork maxRows">
	<template>
        <link rel="stylesheet" href="../css/shared-styles.css">
		<style>
			:host {
				display: block;
			}
			h1 {
				font-size: 1.8rem;
				font-weight: 100;
				padding: 0 0 0 10px;
			}
	    </style>

		<toast-ajax
			auto
			id="tickListAPI"
			url="{{ticking_service + '/tick/list/' + gid}}"
			handleAs="json"
			on-core-response="{{tickListResponse}}"

			popUpError
			captureError
			waitMessage="Loading ticks....">
		</toast-ajax>

		<!-- Add Tick Element -->
		<add-tick id="tickAdder" gid="{{gid}}" on-tick-added="{{tickAddedHandler}}"></add-tick>

		<!-- Delete tick from group API. -->
		<toast-ajax id="deleteTickAPI"
			method="DELETE"
			on-core-response="{{deleteTickResponse}}"
			on-core-error="{{deleteTickError}}"

			popUpResponse
			responseMessage="Successfully removed tick from group."
			waitBeforeToast="500"
            waitMessage="Removing tick..."
            popUpError
            captureError>
    	</toast-ajax>

		<!-- Tick list card header. -->
		<div id="headerBar" layout horizontal center>
			<!--<h1 flex>Ticks ({{ticks ? ticks.length : 0}})</h1>-->
            <span flex></span>
			<search-box id="searchBox" placeholder="Search..."></search-box>
			<template if="{{isAuthor}}">
	            <core-tooltip label="Add">
				    <paper-icon-button id="addTickButton" icon="add" on-click="{{addTickClicked}}"></paper-icon-button>
	            </core-tooltip>
	            <core-tooltip label="Remove" class="delete-tooltip">
				    <paper-icon-button id="deleteTickButton" icon="delete" on-click="{{deleteTickClicked}}"></paper-icon-button>
	            </core-tooltip>
	        </template>
		</div>

		<!-- Tick list. -->
		<box-list id="list" selector on-core-select="{{selected}}" valueattr="tick" maxRows="{{maxRows}}">
			<template repeat="{{tickFork in tickForks | tickListFilter($.searchBox.query)}}">
				<tick-box class="itemBox" tick="{{tickFork.tick}}" fork="{{tickFork.fork}}"></tick-box>
			</template>
		</box-list>

	</template>
	<script src="../js/hardcoded.js"></script>
	<script>
		Polymer('tick-list', {

			ticking_service: ticking_service,

			tickListResponse: function () {
                this.tickForks = this.$.tickListAPI.response;
			},

            forkStatusUpdated: function(detail) {
                if (detail.statusCode == "-") {
                    return;
                }

                this.tickForks.map(function(el) {
                    if (el.tick._id == detail.tickId) {
                        el.statusCode = detail.statusCode;
                    }
                })
            },

			tickListFilter: function(items, q) {
				if (items && q) {
					this.$.list.resize();
					return items.filter(this.tickFilter.bind(this));
				}
				return items;
			},

			tickFilter: function(item) {
				var q = this.$.searchBox.query.toLowerCase();
				return (item.tick.name.toLowerCase().indexOf(q) > -1 ||
						item.tick.author.toLowerCase().indexOf(q) > -1);
			},

			selected: function() {
				var sel = this.$.list.$.selector.selected;
				this.selectedTickId = sel._id;
				this.selectedTickIdName = sel.name;
                this.selectedTickObj = sel;

                if (this.canFork) {
                    this.forkClicked();
                }
			},

			forkClicked: function () {
				if (this.selectedTickId)
					this.fire('fork-clicked', {
						tickId: this.selectedTickId,
						tickName: this.selectedTickIdName,
                        tickObj: this.selectedTickObj
					});
			},

			tickAddedHandler: function () {
				this.$.tickListAPI.go();
			},

			addTickClicked: function () {
				this.$.tickAdder.$.dialog.toggle();
			},

			deleteTickClicked: function () {
				if (this.selectedTickId) {
					this.$.deleteTickAPI.url = ticking_service + "/tick/" + this.selectedTickId + "/" + this.gid
					this.$.deleteTickAPI.go();
				}
			},

			deleteTickResponse: function () {
				this.$.tickListAPI.go();
				this.$.list.$.selector.selected = null;
				this.fire('fork-clicked', {
						tickId: null,
						tickName: null,
                        tickObj: null,
					});
			}
		});
	</script>
</polymer-element>
