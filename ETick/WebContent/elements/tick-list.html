<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-selector/core-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-icons/iconsets/communication-icons.html">
<link rel="import" href="search-box.html">
<link rel="import" href="tick-box.html">

<polymer-element name="tick-list" attributes="gid canFork">
	<template>
		<style shim-shadowdom>
			:host {
				display: block;
			}
			h1 {
				font-size: 1.8rem;
				font-weight: 100;
				padding: 0 0 0 10px;
			}
			tick-box {
				width: calc(100% / 3);
			}
			tick-box:nth-child(odd) {
				background: #f6f6f6;
			}
			tick-box:nth-child(even) {
				background: #e9e9e9;
			}
			tick-box.core-selected{
				background: linear-gradient(#E1BEE7, #D697EE);
				color: #6300CE;
			}
			tick-box.core-selected::shadow h2 {
				color: #000;
			}
			tick-box::shadow paper-ripple {
				color: #3C00FF;
			}
	</style>
		<core-ajax
			auto
			id="tickListAPI"
			url="{{'http://urop2014.dtg.cl.cam.ac.uk/UROP_UI/api/tick/list/' + gid}}"
			handleAs="json"
			on-core-response="{{tickListResponse}}">
		</core-ajax>


		<!-- Tick list card header. -->
		<div id="headerBar" layout horizontal center>
			<!--<h1 flex>Ticks ({{ticks ? ticks.length : 0}})</h1>-->
            <span flex></span>
			<template if="{{canFork}}">
				<paper-icon-button icon="communication:call-split" on-click="{{forkClicked}}"></paper-icon-button>
			</template>
			<search-box id="searchBox" placeholder="Search..."></search-box>
		</div>

		<!-- Tick list. -->
		<core-selector id="selector" on-core-select="{{selected}}" valueattr="tick"
			layout horizontal center wrap>
			<template repeat="{{tick in ticks | tickListFilter($.searchBox.query)}}">
				<tick-box tickId="{{tick._id}}" tickName="{{tick.name}}" tick="{{tick}}"></tick-box>
			</template>
		</core-selector>

	</template>
	<script>
		Polymer('tick-list', {
			tickListResponse: function () {
				this.ticks = this.$.tickListAPI.response;
			},

			tickListFilter: function(items, q) {
				if (items && q) {
					return items.filter(this.tickFilter.bind(this));
				}
				return items;
			},

			tickFilter: function(item) {
				var q = this.$.searchBox.query.toLowerCase();
				return (item.name.toLowerCase().indexOf(q) > -1 ||
						item.author.toLowerCase().indexOf(q) > -1);
			},

			selected: function() {
				var sel = this.$.selector.selected;
				this.selectedTickId = sel._id;
				this.selectedTickIdName = sel.name;
			},

			forkClicked: function () {
				if (this.selectedTickId)
					this.fire('fork-clicked', {
						tickId: this.selectedTickId,
						tickName: this.selectedTickIdName
					});
			}
		});
	</script>
</polymer-element>